

<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sawem Shop</title>
  <meta name="description" content="Sawem Shop - Produits tech et électroniques">
  <meta name="verify-admitad" content="5ae23ad5f3" />
  <!-- Preconnect -->
  <link rel="preconnect" href="https://sawem-backend.onrender.com">
  <link rel="preconnect" href="https://api.jina.ai">
  <link rel="dns-prefetch" href="//ui-avatars.com">
  <link rel="icon" type="image/png" href="Images/icone_Sawem.shop.png" />
  <!-- CSS -->
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <!-- ==================== HEADER ==================== -->
  <header>
    <div class="container header-container">
      <div class="header-left">
        <h1>Sawem.shop</h1>
        <span class="cart">🛒</span>
      </div>
      <div class="header-right">
        <div id="authStatus" class="auth-status loading">⏳ Vérification...</div>
        <div id="userInfo" class="user-info" style="display:none;">
          <img id="userAvatar" class="user-avatar" src="" alt="Avatar" width="32" height="32" loading="lazy"/>
          <div class="user-details">
            <div id="userName" class="user-name"></div>
            <div id="userEmail" class="user-email"></div>
          </div>
          <button id="logoutBtn" class="logout-btn" type="button">Déconnexion</button>
        </div>
        <a id="adminLink" class="admin-link" href="admin.html" style="display:none;">🔧 Administration</a>
        <a id="googleLoginBtn" class="google-btn" href="#" style="display:none;">Se connecter avec Google</a>
      </div>
    </div>
  </header>
  <!-- ==================== NOTIFICATION ==================== -->
  <div id="notification" class="notification" role="alert" aria-live="polite"></div>
  <!-- ==================== MAIN ==================== -->
  <main class="container">
    <!-- ===== MESSAGE DE BIENVENUE ===== -->
    <div id="welcomeMessage" class="welcome-message" style="display:none;">
      <h3>Bienvenue <span id="welcomeUserName"></span> ! 👋</h3>
      <p>Vous pouvez maintenant voter et laisser des avis sur les produits.</p>
    </div>
    <!-- ===== RECHERCHE & FILTRES ===== -->
    <section class="search-section">
      <h2 class="section-title">Produits Tech et Electroniques</h2>
      <!-- Barre de recherche principale -->
      <div class="search-container">
        <input type="text" id="searchInput" placeholder="Rechercher des produits..." class="search-input">
        <div class="search-buttons">
          <button id="textSearchBtn" class="search-btn text-search" title="Recherche textuelle rapide">
            🔍 Recherche
          </button>
          <button id="aiSearchBtn" class="search-btn ai-search" title="Recherche IA intelligente">
            🤖 Recherche IA
          </button>
        </div>
      </div>
      <!-- Catégories -->
      <div class="categories-section">
        <h2>🔍 Recherche par catégorie</h2>
        <div class="categories-grid">
          <button class="category-btn" data-search="smartphones">📱 Smartphones</button>
          <button class="category-btn" data-search="laptops">💻 Laptops</button>
          <button class="category-btn" data-search="casques audio">🎧 Casques Audio</button>
          <button class="category-btn" data-search="montres connectées">⌚ Montres Connectées</button>
          <button class="category-btn" data-search="tablettes">📱 Tablettes</button>
          <button class="category-btn" data-search="appareils photo">📸 Appareils Photo</button>
          <button class="category-btn" data-search="gaming">🎮 Gaming</button>
          <button class="category-btn" data-search="drones">🚁 Drones</button>
          <button class="category-btn" data-search="enceintes">🔊 Enceintes</button>
          <button class="category-btn" data-search="claviers">⌨️ Claviers</button>
          <button class="category-btn" data-search="souris">🖱️ Souris</button>
          <button class="category-btn" data-search="écrans">🖥️ Écrans</button>
        </div>
      </div>
      <!-- Filtres avancés -->
      <div class="filters-container">
        <div class="filter-group">
          <label for="sourceFilter">Source :</label>
          <select id="sourceFilter" class="filter-select">
            <option value="">Toutes les sources</option>
            <option value="aliexpress">AliExpress</option>
            <option value="amazon">Amazon</option>
            <option value="other">Autres</option>
          </select>
        </div>
        <div class="filter-group price-filter-group">
          <label for="priceRange">Gamme de prix :</label>
          <div class="price-range-container">
            <input type="range" id="priceRange" class="price-slider" min="0" max="1000" value="1000" step="10">
            <div class="price-display">
              <span>0€ - <span id="priceDisplay">1000€+</span></span>
            </div>
          </div>
        </div>
        <div class="filter-group">
          <label for="sortBy">Trier par :</label>
          <select id="sortBy" class="filter-select">
            <option value="relevance">Pertinence</option>
            <option value="price_asc">Prix croissant</option>
            <option value="price_desc">Prix décroissant</option>
            <option value="rating_desc">Meilleures notes</option>
            <option value="newest">Plus récents</option>
          </select>
        </div>
        <button id="clearFiltersBtn" class="clear-filters-btn">Réinitialiser les filtres</button>
      </div>
    </section>
    <!-- ===== STATISTIQUES (remplacé) ===== -->
    <div id="searchStats" class="search-stats" style="display: none;">
      <div class="search-results-info">
        <span id="resultsCount">0 résultats</span>
        <span id="searchQuery"></span>
      </div>
    </div>
    <!-- ===== PRODUITS ===== -->
    <div id="productsContainer" class="products-container">
      <div class="loading-skeleton">
        <div class="skeleton-card"></div>
        <div class="skeleton-card"></div>
        <div class="skeleton-card"></div>
        <div class="skeleton-card"></div>
        <div class="skeleton-card"></div>
        <div class="skeleton-card"></div>
      </div>
    </div>
    <!-- ===== PAGINATION ===== -->
    <div id="pagination" class="pagination" style="display:none;">
      <button id="prevPageBtn" class="page-btn">← Précédent</button>
      <span id="pageInfo" class="page-info">Page 1</span>
      <button id="nextPageBtn" class="page-btn">Suivant →</button>
    </div>
  </main>
  <!-- ==================== FOOTER ==================== -->
  <footer>
    <div class="container">
      <p>&copy; 2025 Sawem.shop - Tous droits réservés. | +33 7 45 43 87 28 | <a href="mailto:imadbelkaceminfo@gmail.com">imadbelkaceminfo@gmail.com</a></p>
    </div>
  </footer>
  <!-- ==================== SCRIPTS ==================== -->
  <script>
    const BACKEND_URL = "https://sawem-backend.onrender.com";
    let currentUser = null;
    let authToken = null;
    let currentProducts = []; // Déclaration déplacée ici
    let filteredProducts = []; // Déclaration déplacée ici
    // Fonction pour rendre les étoiles proportionnelles
    // Remplacer la fonction renderStars dans votre index.html

function renderStars(rating) {
  // CORRECTION : Convertir rating en nombre et gérer les cas invalides
  const numRating = Number(rating) || 0;
  const fullStars = Math.floor(numRating);
  const hasHalfStar = (numRating - fullStars) >= 0.5;

  let starsHTML = '';
  for (let i = 1; i <= 5; i++) {
    if (i <= fullStars) {
      starsHTML += '<span class="star full">★</span>';
    } else if (hasHalfStar && i === fullStars + 1) {
      starsHTML += '<span class="star half">☆</span>';
    } else {
      starsHTML += '<span class="star empty">☆</span>';
    }
  }

  return `<div class="stars">${starsHTML}</div><span class="rating-text"> (${numRating.toFixed(1)}/5)</span>`;
}
    // Auth functions
    function getToken() {
      if (!authToken) authToken = localStorage.getItem('sawem_auth_token');
      return authToken;
    }
    function getAuthHeaders() {
      const token = getToken();
      return token ? {'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json'} : {'Content-Type': 'application/json'};
    }
    // Load products function - CORRIGÉE
    async function loadProducts() {
      try {
        console.log('Chargement des produits...');
        const res = await fetch(`${BACKEND_URL}/products`, {
          headers: getAuthHeaders()
        });

        console.log('Réponse reçue:', res.status);

        if (!res.ok) {
          throw new Error(`HTTP ${res.status}`);
        }

        const products = await res.json();
        console.log('Produits reçus:', products.length);

        if (!Array.isArray(products)) {
          throw new Error('Format de données invalide');
        }

        currentProducts = products;
        filteredProducts = products;
        displayProducts(products);

      } catch (err) {
        console.error('Load products error:', err);
        const container = document.getElementById('productsContainer');
        container.innerHTML = `
          <div style="text-align: center; padding: 2rem; background: #f8d7da; color: #721c24; border-radius: 8px; margin: 1rem 0;">
            <h3>Erreur de chargement des produits</h3>
            <p>Détails: ${err.message}</p>
            <button onclick="loadProducts()" style="background: #0d6efd; color: white; padding: 0.5rem 1rem; border: none; border-radius: 4px; cursor: pointer; margin-top: 1rem;">
              Réessayer
            </button>
          </div>
        `;
      }
    }
    // Display products function - CORRIGÉE
    function displayProducts(products) {
      const container = document.getElementById('productsContainer');
      if (!products || products.length === 0) {
        container.innerHTML = '<div class="no-products">Aucun produit trouvé</div>';
        return;
      }
      let html = '';
      products.forEach(product => {
        const token = localStorage.getItem('sawem_auth_token');
        const isLoggedIn = !!token;

        let sourceClass = 'source-other';
        let sourceName = 'Autre';
        if (product.source && product.source.toLowerCase().includes('aliexpress')) {
          sourceClass = 'source-aliexpress';
          sourceName = 'AliExpress';
        } else if (product.source && product.source.toLowerCase().includes('amazon')) {
          sourceClass = 'source-amazon';
          sourceName = 'Amazon';
        }
        const sourceInfo = `<div class="product-source ${sourceClass}">${sourceName}</div>`;
        const reviewsHTML = (product.reviews && Array.isArray(product.reviews) && product.reviews.length > 0) ?
          product.reviews.map(review => `
            <div class="review-item">
              <strong>${review.user_name || 'Anonyme'}</strong>: ${review.comment || ''}
              <span class="review-date">${review.created_at ? new Date(review.created_at).toLocaleDateString() : ''}</span>
            </div>
          `).join('') : '<p>Aucun avis pour le moment</p>';
        html += `
          <div class="product-card">
            <img src="${product.image || ''}" alt="${product.title || ''}"
                 onerror="this.style.display='none'" />
            ${sourceInfo}
            <div class="product-info">
              <h3>${product.title || 'Titre non disponible'}</h3>
              <p class="price">${product.price || 'Prix non disponible'}</p>
              <div class="rating">${renderStars(product.user_rating || 0)}</div>
              <div class="product-actions">
                <a href="${product.link || '#'}" target="_blank" class="view-btn">Voir le produit</a>
                <button onclick="promptVote(${product.id})" class="vote-btn" ${!isLoggedIn ? 'disabled' : ''}>
                  Voter
                </button>
              </div>
              <div class="reviews-section">
                <div class="reviews-list">${reviewsHTML}</div>
                ${isLoggedIn ? `
                  <div class="review-form">
                    <textarea id="review-${product.id}" placeholder="Votre avis..." rows="2"></textarea>
                    <button onclick="submitReview(${product.id})" class="send-review-btn">Envoyer</button>
                  </div>
                ` : '<p class="login-prompt">Connectez-vous pour laisser un avis</p>'}
              </div>
            </div>
          </div>
        `;
      });
      container.innerHTML = `<div class="product-grid">${html}</div>`;
    }
    // Search functions - CORRIGÉES
    async function performTextSearch(query) {
      if (!query) {
        loadProducts();
        return;
      }

      try {
        const res = await fetch(`${BACKEND_URL}/search`, {
          method: 'POST',
          headers: getAuthHeaders(),
          body: JSON.stringify({ query: query.trim(), type: 'text' })
        });

        if (!res.ok) throw new Error(`HTTP ${res.status}`);

        const products = await res.json();

        // Vérifier que products est un tableau
        if (!Array.isArray(products)) {
          throw new Error('Format de réponse invalide');
        }

        displayProducts(products);

        // Update stats
        document.getElementById('resultsCount').textContent = `${products.length} résultats`;
        document.getElementById('searchQuery').textContent = `pour "${query}"`;
        document.getElementById('searchStats').style.display = 'block';

      } catch (err) {
        console.error('Text search error:', err);
        document.getElementById('productsContainer').innerHTML = `
          <div style="text-align: center; padding: 2rem; background: #f8d7da; color: #721c24; border-radius: 8px;">
            <p>Erreur de recherche: ${err.message}</p>
            <button onclick="loadProducts()" style="background: #0d6efd; color: white; padding: 0.5rem 1rem; border: none; border-radius: 4px; cursor: pointer;">
              Retour aux produits
            </button>
          </div>
        `;
      }
    }
    async function performAISearch(query) {
      if (!query) return;

      try {
        const res = await fetch(`${BACKEND_URL}/search`, {
          method: 'POST',
          headers: getAuthHeaders(),
          body: JSON.stringify({ query: query.trim(), type: 'ai' })
        });

        if (!res.ok) throw new Error(`HTTP ${res.status}`);

        const products = await res.json();

        // Vérifier que products est un tableau
        if (!Array.isArray(products)) {
          throw new Error('Format de réponse invalide');
        }

        displayProducts(products);

      } catch (err) {
        console.error('AI search error:', err);
        // Fallback to text search
        performTextSearch(query);
      }
    }
    // Fonction utilitaire pour extraire le prix numérique
    // Remplacer la fonction extractPrice dans votre index.html

  function extractPrice(priceStr) {
  if (!priceStr) return 0;
  
  // Nettoyer la chaîne et extraire les nombres
  const cleanStr = priceStr.replace(/[^\d,.\$€]/g, '');
  const numbers = cleanStr.match(/[\d,\.]+/);
  
  if (!numbers) return 0;
  
  let price = parseFloat(numbers[0].replace(',', '.'));
  
  // Conversion approximative Dollar vers Euro (taux ~0.85)
  // Si le prix original contient $, on le convertit en euros pour le filtre
  if (priceStr.includes('$')) {
    price = price * 0.85; // Conversion approximative
  }
  
  return price || 0;
}

    // Initialisation des sliders de prix
    function initPriceSliders() {
      const priceSlider = document.getElementById('priceRange');
      const priceDisplay = document.getElementById('priceDisplay');
      function updatePriceDisplay() {
        const maxVal = parseInt(priceSlider.value);
        priceDisplay.textContent = maxVal >= 1000 ? '1000€+' : maxVal + '€';
        applyFilters();
      }
      priceSlider.addEventListener('input', updatePriceDisplay);
    }
    // Fonction pour appliquer tous les filtres
    function applyFilters() {
  if (!currentProducts.length) return;

  let filtered = [...currentProducts];

  // Filtre par source
  const sourceFilter = document.getElementById('sourceFilter').value;
  if (sourceFilter) {
    if (sourceFilter === 'aliexpress') {
      filtered = filtered.filter(p => (p.source || '').toLowerCase().includes('aliexpress'));
    } else if (sourceFilter === 'amazon') {
      filtered = filtered.filter(p => (p.source || '').toLowerCase().includes('amazon'));
    } else if (sourceFilter === 'other') {
      filtered = filtered.filter(p => {
        const source = (p.source || '').toLowerCase();
        return !source.includes('aliexpress') && !source.includes('amazon');
      });
    }
  }

  // Filtre par prix - CORRIGÉ
  const maxPrice = parseInt(document.getElementById('priceRange').value);
  filtered = filtered.filter(p => {
    const price = extractPrice(p.price);
    return price <= maxPrice;
  });

  // Tri
  const sortBy = document.getElementById('sortBy').value;
  switch(sortBy) {
    case 'price_asc':
      filtered.sort((a, b) => extractPrice(a.price) - extractPrice(b.price));
      break;
    case 'price_desc':
      filtered.sort((a, b) => extractPrice(b.price) - extractPrice(a.price));
      break;
    case 'rating_desc':
      filtered.sort((a, b) => (b.user_rating || 0) - (a.user_rating || 0));
      break;
    case 'newest':
      filtered.sort((a, b) => new Date(b.created_at || 0) - new Date(a.created_at || 0));
      break;
  }

  filteredProducts = filtered;
  displayProducts(filtered);
}
    // Fonction pour réinitialiser les filtres
    function clearAllFilters() {
      document.getElementById('sourceFilter').value = '';
      document.getElementById('priceRange').value = 1000;
      document.getElementById('priceDisplay').textContent = '1000€+';
      document.getElementById('sortBy').value = 'relevance';
      document.getElementById('searchInput').value = '';
      // Cacher les stats de recherche
      document.getElementById('searchStats').style.display = 'none';
      // Recharger tous les produits
      loadProducts();
    }
    // Fonction d'authentification améliorée
    async function checkUser() {
      const authStatus = document.getElementById('authStatus');
      const googleLoginBtn = document.getElementById('googleLoginBtn');
      try {
        authStatus.textContent = "⏳ Vérification...";
        authStatus.className = "auth-status loading";
        // Vérifier le token dans l'URL
        const urlParams = new URLSearchParams(window.location.search);
        const urlToken = urlParams.get('token');
        if (urlToken) {
          localStorage.setItem('sawem_auth_token', urlToken);
          authToken = urlToken;
          window.history.replaceState({}, document.title, window.location.pathname);
        }
        const token = getToken();
        if (!token) {
          throw new Error("Aucun token");
        }
        const res = await fetch(`${BACKEND_URL}/verify-token`, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({token})
        });
        if (!res.ok) throw new Error('Token invalide');
        const data = await res.json();
        if (data.success && data.user) {
          currentUser = data.user;
          displayUserConnected(data.user);
        } else {
          throw new Error('Données utilisateur invalides');
        }
      } catch (err) {
        console.error('Auth error:', err);
        authToken = null;
        localStorage.removeItem('sawem_auth_token');
        displayUserDisconnected();
      }
    }
    function displayUserConnected(user) {
      const authStatus = document.getElementById('authStatus');
      const googleLoginBtn = document.getElementById('googleLoginBtn');
      const userInfo = document.getElementById('userInfo');
      const userName = document.getElementById('userName');
      const userEmail = document.getElementById('userEmail');
      const userAvatar = document.getElementById('userAvatar');
      const welcomeMessage = document.getElementById('welcomeMessage');
      const welcomeUserName = document.getElementById('welcomeUserName');
      const adminLink = document.getElementById('adminLink');
      const logoutBtn = document.getElementById('logoutBtn');
      if (authStatus) authStatus.style.display = "none";
      if (googleLoginBtn) googleLoginBtn.style.display = "none";
      if (userName) userName.textContent = user.name || "Utilisateur";
      if (userEmail) userEmail.textContent = user.email || "";
      if (userAvatar) {
        userAvatar.src = user.photo ||
          `https://ui-avatars.com/api/?name=${encodeURIComponent(user.name || 'User')}&size=40&background=0d6efd&color=fff`;
        userAvatar.alt = user.name || "Avatar";
      }
      if (userInfo) userInfo.style.display = "flex";
      if (welcomeUserName) welcomeUserName.textContent = user.name || "Utilisateur";
      if (welcomeMessage) welcomeMessage.style.display = "block";
      // Afficher le lien admin si admin
      if (adminLink && user.role === 'admin') {
        adminLink.style.display = 'inline-flex';
      }
      // Ajouter événement au bouton de déconnexion
      logoutBtn.onclick = () => {
        localStorage.removeItem('sawem_auth_token');
        window.location.reload();
      };
    }
    function displayUserDisconnected() {
      const authStatus = document.getElementById('authStatus');
      const googleLoginBtn = document.getElementById('googleLoginBtn');
      const welcomeMessage = document.getElementById('welcomeMessage');
      const adminLink = document.getElementById('adminLink');
      if (authStatus) {
        authStatus.textContent = "❌ Non connecté";
        authStatus.className = "auth-status disconnected";
        authStatus.style.display = "block";
      }
      if (googleLoginBtn) {
        googleLoginBtn.href = `${BACKEND_URL}/auth/google`;
        googleLoginBtn.style.display = "flex";
      }
      if (welcomeMessage) welcomeMessage.style.display = 'none';
      if (adminLink) adminLink.style.display = 'none';
    }
    // Fonction pour voter - CORRIGÉE
    function promptVote(productId) {
      const token = localStorage.getItem('sawem_auth_token');
      if (!token) {
        alert("Veuillez vous connecter pour voter");
        return;
      }
      const rating = prompt("Notez ce produit de 1 à 5 étoiles:");
      if (rating && rating >= 1 && rating <= 5) {
        fetch(`${BACKEND_URL}/vote`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            product_id: productId,
            stars: parseInt(rating)
          })
        })
        .then(response => {
          if (!response.ok) {
            throw new Error('Erreur réseau');
          }
          return response.json();
        })
        .then(data => {
          alert(`Vote enregistré: ${rating}/5 étoiles`);
          loadProducts(); // Recharger les produits
        })
        .catch(error => {
          console.error('Erreur vote:', error);
          alert("Erreur lors du vote");
        });
      }
    }
    // Fonction pour envoyer un commentaire - CORRIGÉE
    function submitReview(productId) {
      const token = localStorage.getItem('sawem_auth_token');
      if (!token) {
        alert("Veuillez vous connecter pour laisser un avis");
        return;
      }
      const textarea = document.getElementById(`review-${productId}`);
      const comment = textarea.value.trim();

      if (!comment) {
        alert("Veuillez écrire un commentaire");
        return;
      }
      fetch(`${BACKEND_URL}/review`, {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          product_id: productId,
          comment: comment
        })
      })
      .then(response => {
        if (!response.ok) {
          throw new Error('Erreur réseau');
        }
        return response.json();
      })
      .then(data => {
        alert("Avis publié avec succès");
        textarea.value = '';
        loadProducts(); // Recharger les produits
      })
      .catch(error => {
        console.error('Erreur commentaire:', error);
        alert("Erreur lors de l'envoi du commentaire");
      });
    }
    // Event listeners - CORRIGÉ
    document.addEventListener('DOMContentLoaded', () => {
      checkUser();
      loadProducts();
      initPriceSliders();
      const sourceFilter = document.getElementById('sourceFilter');
      const sortBy = document.getElementById('sortBy');
      const clearFiltersBtn = document.getElementById('clearFiltersBtn');
      if (sourceFilter) sourceFilter.addEventListener('change', applyFilters);
      if (sortBy) sortBy.addEventListener('change', applyFilters);
      if (clearFiltersBtn) clearFiltersBtn.addEventListener('click', clearAllFilters);
      const textSearchBtn = document.getElementById('textSearchBtn');
      const aiSearchBtn = document.getElementById('aiSearchBtn');
      const searchInput = document.getElementById('searchInput');
      if (textSearchBtn && searchInput) {
        textSearchBtn.addEventListener('click', () => {
          const query = searchInput.value.trim();
          performTextSearch(query);
        });
      }
      if (aiSearchBtn && searchInput) {
        aiSearchBtn.addEventListener('click', () => {
          const query = searchInput.value.trim();
          performAISearch(query);
        });
      }
      document.querySelectorAll('.category-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const query = btn.dataset.search;
          if (searchInput && query) {
            searchInput.value = query;
            performTextSearch(query);
          }
        });
      });
      if (searchInput) {
        searchInput.addEventListener('keypress', (e) => {
          if (e.key === 'Enter') {
            const query = searchInput.value.trim();
            performTextSearch(query);
          }
        });
      }
    });
  </script>
</body>
</html>
