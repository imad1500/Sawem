<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sawem Shop</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <!-- ==================== Header ==================== -->
  <header>
    <h1>Sawem.shop üõí</h1>
    <div class="header-right">
      <!-- Bouton test temporaire JWT -->
      <button onclick="testJWT()" style="background: #17a2b8; color: white; padding: 5px 10px; border: none; border-radius: 3px; margin-right: 10px; cursor: pointer;">Test JWT</button>
      
      <!-- Statut d'authentification -->
      <div id="authStatus" class="auth-status loading">
        ‚è≥ V√©rification...
      </div>
      
      <!-- Zone utilisateur connect√© (cach√©e par d√©faut) -->
      <div id="userInfo" class="user-info" style="display: none;">
        <img id="userAvatar" class="user-avatar" src="" alt="Avatar" />
        <div class="user-details">
          <div id="userName" class="user-name"></div>
          <div id="userEmail" class="user-email"></div>
        </div>
        <button id="logoutBtn" class="logout-btn">D√©connexion</button>
      </div>
      
      <!-- Bouton de connexion (cach√© par d√©faut) -->
      <a id="googleLoginBtn" class="google-btn" href="#" style="display: none;">
        üîó Se connecter avec Google
      </a>
    </div>
  </header>

  <!-- ==================== Notification ==================== -->
  <div id="notification" class="notification"></div>

  <!-- ==================== Main / Produits ==================== -->
  <main>
    <!-- Zone de recherche centr√©e -->
    <div class="search-container">
      <input type="text" id="searchInput" placeholder="Rechercher un produit..." />
      <button id="searchBtn">Rechercher</button>
    </div>

    <!-- Message de bienvenue pour utilisateur connect√© -->
    <div id="welcomeMessage" class="welcome-message" style="display: none;">
      <h2>Bienvenue <span id="welcomeUserName"></span> ! üëã</h2>
      <p>Vous pouvez maintenant voter et laisser des avis sur les produits.</p>
    </div>

    <!-- Produits dynamiques -->
    <div id="productsContainer">
      <p>‚è≥ Chargement des produits...</p>
    </div>
  </main>

  <!-- ==================== Footer ==================== -->
  <footer>
    <p>&copy; 2025 Sawem.shop - Tous droits r√©serv√©s.</p>
  </footer>

  <!-- ==================== Scripts ==================== -->
  <script>
    const BACKEND_URL = "https://sawem-backend.onrender.com"; 

    // √âl√©ments DOM
    const searchInput = document.getElementById("searchInput");
    const searchBtn = document.getElementById("searchBtn");
    const productsContainer = document.getElementById("productsContainer");
    const googleLoginBtn = document.getElementById("googleLoginBtn");
    const logoutBtn = document.getElementById("logoutBtn");
    const authStatus = document.getElementById("authStatus");
    const userInfo = document.getElementById("userInfo");
    const userAvatar = document.getElementById("userAvatar");
    const userName = document.getElementById("userName");
    const userEmail = document.getElementById("userEmail");
    const welcomeMessage = document.getElementById("welcomeMessage");
    const welcomeUserName = document.getElementById("welcomeUserName");
    const notification = document.getElementById("notification");

    // Variable globale pour l'√©tat utilisateur
    let currentUser = null;
    let authToken = null;

    // ==================== JWT Token Management ====================
    function saveToken(token) {
      localStorage.setItem('sawem_auth_token', token);
      authToken = token;
      console.log('Token saved to localStorage');
    }

    function getToken() {
      if (!authToken) {
        authToken = localStorage.getItem('sawem_auth_token');
      }
      return authToken;
    }

    function removeToken() {
      localStorage.removeItem('sawem_auth_token');
      authToken = null;
      console.log('Token removed from localStorage');
    }

    function getAuthHeaders() {
      const token = getToken();
      return token ? {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      } : {
        'Content-Type': 'application/json'
      };
    }

    // ==================== Utilitaires ====================
    function escapeHtml(s) {
      return String(s || "").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[m]));
    }

    function showNotification(message, type = 'success') {
      notification.textContent = message;
      notification.className = `notification ${type}`;
      notification.classList.add('show');
      setTimeout(() => {
        notification.classList.remove('show');
      }, 3000);
    }

    function renderStarsHTML(rating) {
      const r = Number(rating || 0);
      const full = Math.floor(r);
      const half = r - full >= 0.5;
      let html = "";
      for (let i = 1; i <= 5; i++) {
        if (i <= full) html += '<span class="star full">‚òÖ</span>';
        else if (half && i === full + 1) html += '<span class="star half">‚òÖ</span>';
        else html += '<span class="star empty">‚òÖ</span>';
      }
      return html;
    }

    function renderReviewsList(reviews) {
      if (!reviews || !reviews.length) return `<div class="reviews-list-empty">Aucun avis</div>`;
      return reviews.map(r => `
        <div class="single-review">
          <div class="rev-head"><strong>${escapeHtml(r.user_name || 'Anonyme')}</strong>
            <span class="rev-date">${new Date(r.created_at).toLocaleString()}</span>
          </div>
          <div class="rev-body">${escapeHtml(r.comment)}</div>
        </div>
      `).join("");
    }

    // ==================== Gestion utilisateur JWT ====================
    async function checkUser() {
      try {
        authStatus.textContent = "‚è≥ V√©rification...";
        authStatus.className = "auth-status loading";
        
        // V√©rifier d'abord s'il y a un token dans l'URL (apr√®s OAuth)
        const urlParams = new URLSearchParams(window.location.search);
        const urlToken = urlParams.get('token');
        
        if (urlToken) {
          console.log('Token trouv√© dans URL apr√®s OAuth');
          saveToken(urlToken);
          // Nettoyer l'URL
          window.history.replaceState({}, document.title, window.location.pathname);
        }
        
        const token = getToken();
        if (!token) {
          throw new Error("Aucun token disponible");
        }
        
        // V√©rifier le token avec le serveur
        const res = await fetch(`${BACKEND_URL}/verify-token`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ token })
        });
        
        console.log('Verify token response status:', res.status);
        
        if (!res.ok) {
          const errorData = await res.json();
          console.log('Token verification failed:', errorData);
          throw new Error("Token invalide");
        }
        
        const data = await res.json();
        console.log('Token verification success:', data);
        
        if (data.success && data.user) {
          currentUser = data.user;
          displayUserConnected(data.user);
          
          // V√©rifier si on vient d'une redirection OAuth
          if (urlToken || urlParams.get('auth') === 'success') {
            showNotification(`Connexion r√©ussie ! Bienvenue ${data.user.name}`, 'success');
          }
        } else {
          throw new Error("Donn√©es utilisateur invalides");
        }
      } catch (error) {
        console.error('checkUser error:', error);
        currentUser = null;
        removeToken(); // Supprimer le token invalide
        displayUserDisconnected();
        
        // V√©rifier si on vient d'une redirection OAuth qui a √©chou√©
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('auth') === 'error') {
          showNotification("Erreur lors de la connexion", 'error');
          window.history.replaceState({}, document.title, window.location.pathname);
        }
      }
    }

    function displayUserConnected(user) {
      // Cacher le statut de chargement et le bouton de connexion
      authStatus.style.display = "none";
      googleLoginBtn.style.display = "none";
      
      // Afficher les informations utilisateur
      userName.textContent = user.name || "Utilisateur";
      userEmail.textContent = user.email || "";
      
      // Afficher la photo Google si disponible
      if (user.photo) {
        userAvatar.src = user.photo;
        userAvatar.alt = user.name || "Avatar";
      } else {
        // Photo par d√©faut g√©n√©r√©e
        userAvatar.src = `https://ui-avatars.com/api/?name=${encodeURIComponent(user.name || 'User')}&size=40&background=0d6efd&color=fff`;
        userAvatar.alt = user.name || "Avatar";
      }
      
      userInfo.style.display = "flex";
      
      // Afficher le message de bienvenue
      welcomeUserName.textContent = user.name || "Utilisateur";
      welcomeMessage.style.display = "block";
    }

    function displayUserDisconnected() {
      // Cacher les informations utilisateur et le message de bienvenue
      userInfo.style.display = "none";
      welcomeMessage.style.display = "none";
      
      // Afficher le statut d√©connect√© et le bouton de connexion
      authStatus.textContent = "‚ùå Non connect√©";
      authStatus.className = "auth-status disconnected";
      authStatus.style.display = "block";
      
      googleLoginBtn.href = `${BACKEND_URL}/auth/google`;
      googleLoginBtn.style.display = "flex";
    }

    async function logout() {
      try {
        // Informer le serveur (optionnel avec JWT)
        await fetch(`${BACKEND_URL}/logout`, { 
          method: 'POST',
          headers: getAuthHeaders()
        });
        
        // Supprimer le token c√¥t√© client
        removeToken();
        currentUser = null;
        
        showNotification("D√©connexion r√©ussie", 'success');
        displayUserDisconnected();
      } catch (err) {
        console.error('Logout error:', err);
        // M√™me en cas d'erreur, supprimer le token c√¥t√© client
        removeToken();
        currentUser = null;
        showNotification("D√©connexion effectu√©e", 'success');
        displayUserDisconnected();
      }
    }

    // ==================== Test JWT (temporaire) ====================
    async function testJWT() {
      try {
        console.log('=== TEST JWT ===');
        
        // Test 1: V√©rifier le token local
        const localToken = getToken();
        console.log('Local token:', localToken ? 'EXISTS' : 'NONE');
        
        // Test 2: Tester la g√©n√©ration de token
        const testRes = await fetch(`${BACKEND_URL}/test-jwt`);
        const testData = await testRes.json();
        console.log('Test JWT data:', testData);
        
        // Test 3: V√©rifier avec notre token
        if (localToken) {
          const verifyRes = await fetch(`${BACKEND_URL}/verify-token`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ token: localToken })
          });
          const verifyData = await verifyRes.json();
          console.log('Token verification:', verifyData);
        }
        
        // Test 4: Tester /me avec Authorization header
        if (localToken) {
          const meRes = await fetch(`${BACKEND_URL}/me`, {
            headers: { 'Authorization': `Bearer ${localToken}` }
          });
          console.log('Me status:', meRes.status);
          const meData = await meRes.json();
          console.log('Me data:', meData);
        }
        
        // Afficher le r√©sultat dans une alerte
        alert(`JWT Test:\nLocal token: ${localToken ? 'EXISTS' : 'NONE'}\nUser: ${currentUser ? currentUser.email : 'NONE'}`);
        
      } catch (err) {
        console.error('Test JWT error:', err);
        alert('Erreur test JWT: ' + err.message);
      }
    }

    // ==================== Produits ====================
    function productCardHTML(p) {
      const title = escapeHtml(p.title || "");
      const price = escapeHtml(p.price || "");
      const link = p.link || "#";
      const ratingNum = Number(p.user_rating || 0);
      const starsHTML = renderStarsHTML(ratingNum);
      const reviewsHTML = renderReviewsList(p.reviews || []);

      // D√©sactiver les boutons si pas connect√©
      const voteDisabled = !currentUser ? 'disabled title="Connectez-vous pour voter"' : '';
      const reviewDisabled = !currentUser ? 'disabled placeholder="Connectez-vous pour laisser un avis"' : 'placeholder="Votre avis..."';

      return `
        <div class="product-card" data-id="${p.id}">
          <img src="${p.image || 'https://via.placeholder.com/400x300'}" alt="${title}" />
          <div class="product-info">
            <h3>${title}</h3>
            <p class="price">${price}</p>
            <p class="stars">Vote: ${starsHTML} <span class="rating">(${ratingNum.toFixed(1)})</span></p>
            <div class="product-actions">
              <a class="view-btn" href="${escapeHtml(link)}" target="_blank" rel="noopener">Voir</a>
              <button class="vote-btn" onclick="promptVote(${p.id})" ${voteDisabled}>Voter</button>
            </div>

            <div class="reviews-section">
              <div id="reviews-list-${p.id}" class="reviews-list">${reviewsHTML}</div>
              <textarea id="review-${p.id}" ${reviewDisabled} rows="3"></textarea>
              <button onclick="submitReview(${p.id})" ${!currentUser ? 'disabled' : ''}>Envoyer</button>
            </div>
          </div>
        </div>
      `;
    }

    function displayProducts(products) {
      if (!products || !products.length) {
        productsContainer.innerHTML = "<p>‚ùå Aucun produit trouv√©.</p>";
        return;
      }

      const ali = products.filter(p => (p.source||"").toLowerCase().includes("aliexpress"));
      const amazon = products.filter(p => (p.source||"").toLowerCase().includes("amazon"));
      const others = products.filter(p => {
        const s = (p.source||"").toLowerCase();
        return !s.includes("aliexpress") && !s.includes("amazon");
      });

      let html = "";
      if (ali.length) {
        html += `<div class="source-block"><h2 class="source-title">AliExpress</h2><div class="product-grid">`;
        html += ali.map(productCardHTML).join("");
        html += `</div></div>`;
      }
      if (amazon.length) {
        html += `<div class="source-block"><h2 class="source-title">Amazon</h2><div class="product-grid">`;
        html += amazon.map(productCardHTML).join("");
        html += `</div></div>`;
      }
      if (others.length) {
        html += `<div class="source-block"><h2 class="source-title">Autres</h2><div class="product-grid">`;
        html += others.map(productCardHTML).join("");
        html += `</div></div>`;
      }

      productsContainer.innerHTML = html;
    }

    // ==================== Chargement initial ====================
    async function loadInitialProducts() {
      productsContainer.innerHTML = "<p>‚è≥ Chargement des produits...</p>";
      try {
        const res = await fetch(`${BACKEND_URL}/products`);
        if (!res.ok) throw new Error(await res.text());
        const data = await res.json();
        displayProducts(data);
      } catch (err) {
        console.error("loadInitialProducts error:", err);
        productsContainer.innerHTML = `<p>‚ùå Erreur serveur: ${escapeHtml(err.message||err)}</p>`;
      }
    }

    // ==================== Recherche ====================
    async function searchProducts(q) {
      if (!q || !q.trim()) return loadInitialProducts();
      productsContainer.innerHTML = "<p>‚è≥ Recherche en cours...</p>";
      try {
        const res = await fetch(`${BACKEND_URL}/search`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ query: q }),
        });
        if (!res.ok) throw new Error(await res.text());
        const data = await res.json();
        displayProducts(data);
      } catch (err) {
        console.error("searchProducts error:", err);
        productsContainer.innerHTML = `<p>‚ùå Erreur serveur: ${escapeHtml(err.message||err)}</p>`;
      }
    }

    // ==================== Vote ====================
    async function promptVote(productId) {
      if (!currentUser) {
        showNotification("Veuillez vous connecter pour voter", 'error');
        return;
      }
      
      const input = prompt("Note (1-5) :");
      if (!input) return;
      const stars = Number(input);
      if (!Number.isFinite(stars) || stars < 1 || stars > 5) {
        showNotification("Note invalide (1-5)", 'error');
        return;
      }
      
      try {
        const res = await fetch(`${BACKEND_URL}/vote`, {
          method: "POST",
          headers: getAuthHeaders(),
          body: JSON.stringify({ product_id: productId, stars })
        });
        if (!res.ok) throw new Error(await res.text());
        await res.json();
        showNotification(`Vote enregistr√©: ${stars}/5 √©toiles`, 'success');
        
        const q = (searchInput.value||"").trim();
        if (q) searchProducts(q); else loadInitialProducts();
      } catch (err) {
        console.error("promptVote error:", err);
        if (err.message.includes('401')) {
          showNotification("Session expir√©e, veuillez vous reconnecter", 'error');
          removeToken();
          displayUserDisconnected();
        } else {
          showNotification("Erreur lors du vote", 'error');
        }
      }
    }

    // ==================== Reviews ====================
    async function submitReview(productId) {
      if (!currentUser) {
        showNotification("Veuillez vous connecter pour laisser un avis", 'error');
        return;
      }
      
      const ta = document.getElementById(`review-${productId}`);
      if (!ta) return;
      const comment = ta.value.trim();
      if (!comment) {
        showNotification("√âcrivez un commentaire", 'error');
        return;
      }
      
      try {
        const res = await fetch(`${BACKEND_URL}/review`, {
          method: "POST",
          headers: getAuthHeaders(),
          body: JSON.stringify({ product_id: productId, comment })
        });
        if (!res.ok) throw new Error(await res.text());
        const data = await res.json();
        
        showNotification("Avis publi√© avec succ√®s", 'success');
        
        if (data && Array.isArray(data.reviews)) {
          const list = document.getElementById(`reviews-list-${productId}`);
          if (list) list.innerHTML = renderReviewsList(data.reviews);
        } else {
          const q = (searchInput.value||"").trim();
          if (q) searchProducts(q); else loadInitialProducts();
        }
        ta.value = "";
      } catch (err) {
        console.error("submitReview error:", err);
        if (err.message.includes('401')) {
          showNotification("Session expir√©e, veuillez vous reconnecter", 'error');
          removeToken();
          displayUserDisconnected();
        } else {
          showNotification("Erreur lors de l'envoi de l'avis", 'error');
        }
      }
    }

    // ==================== Events ====================
    searchBtn.addEventListener("click", () => {
      const q = (searchInput.value||"").trim();
      searchProducts(q);
    });

    searchInput.addEventListener("keypress", (e) => {
      if (e.key === "Enter") {
        const q = (searchInput.value||"").trim();
        searchProducts(q);
      }
    });

    logoutBtn.addEventListener("click", logout);

    // ==================== Init ====================
    // V√©rifier l'utilisateur en premier, puis charger les produits
    checkUser().then(() => {
      loadInitialProducts();
    });

    // Expose functions globally for onclick handlers
    window.promptVote = promptVote;
    window.submitReview = submitReview;
    window.testJWT = testJWT;
  </script>
</body>
</html>
