<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sawem Shop</title>
  <meta name="description" content="Sawem Shop - Produits tech et √©lectroniques">
  <meta name="verify-admitad" content="5ae23ad5f3" />
  <!-- Preconnect -->
  <link rel="preconnect" href="https://sawem-backend.onrender.com">
  <link rel="preconnect" href="https://api.jina.ai">
  <link rel="dns-prefetch" href="//ui-avatars.com">
  <link rel="icon" type="image/png" href="Images/icone_Sawem.shop.png" />
  <!-- CSS -->
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <!-- ==================== HEADER ==================== -->
  <header>
    <div class="container header-container">
      <div class="header-left">
        <h1>Sawem.shop</h1>
        <span class="cart">üõí</span>
      </div>
      <div class="header-right">
        <div id="authStatus" class="auth-status loading">‚è≥ V√©rification...</div>
        <div id="userInfo" class="user-info" style="display:none;">
          <img id="userAvatar" class="user-avatar" src="" alt="Avatar" width="32" height="32" loading="lazy"/>
          <div class="user-details">
            <div id="userName" class="user-name"></div>
            <div id="userEmail" class="user-email"></div>
          </div>
          <button id="logoutBtn" class="logout-btn" type="button">D√©connexion</button>
        </div>
        <a id="adminLink" class="admin-link" href="/admin.html" style="display:none;">üîß Administration</a>
        <a id="googleLoginBtn" class="google-btn" href="#" style="display:none;">Se connecter avec Google</a>
      </div>
    </div>
  </header>
  <!-- ==================== NOTIFICATION ==================== -->
  <div id="notification" class="notification" role="alert" aria-live="polite"></div>
  <!-- ==================== MAIN ==================== -->
  <main class="container">
    <!-- ===== RECHERCHE & FILTRES ===== -->
    <section class="search-section">
      <h2 class="section-title">Produits Tech et Electroniques</h2>
      <!-- Barre de recherche principale -->
      <div class="search-container">
        <input type="text" id="searchInput" placeholder="Rechercher des produits..." class="search-input">
        <div class="search-buttons">
          <button id="textSearchBtn" class="search-btn text-search" title="Recherche textuelle rapide">
            üîç Recherche
          </button>
          <button id="aiSearchBtn" class="search-btn ai-search" title="Recherche IA intelligente">
            ü§ñ Recherche IA
          </button>
        </div>
      </div>
      <!-- Cat√©gories -->
      <div class="categories-section">
        <h2>üîç Recherche par cat√©gorie</h2>
        <div class="categories-grid">
          <button class="category-btn" data-search="smartphones">üì± Smartphones</button>
          <button class="category-btn" data-search="laptops">üíª Laptops</button>
          <button class="category-btn" data-search="casques audio">üéß Casques Audio</button>
          <button class="category-btn" data-search="montres connect√©es">‚åö Montres Connect√©es</button>
          <button class="category-btn" data-search="tablettes">üì± Tablettes</button>
          <button class="category-btn" data-search="appareils photo">üì∏ Appareils Photo</button>
          <button class="category-btn" data-search="gaming">üéÆ Gaming</button>
          <button class="category-btn" data-search="drones">üöÅ Drones</button>
          <button class="category-btn" data-search="enceintes">üîä Enceintes</button>
          <button class="category-btn" data-search="claviers">‚å®Ô∏è Claviers</button>
          <button class="category-btn" data-search="souris">üñ±Ô∏è Souris</button>
          <button class="category-btn" data-search="√©crans">üñ•Ô∏è √âcrans</button>
        </div>
      </div>
      <!-- Filtres avanc√©s -->
      <div class="filters-container">
        <div class="filter-group">
          <label for="sourceFilter">Source :</label>
          <select id="sourceFilter" class="filter-select">
            <option value="">Toutes les sources</option>
            <option value="aliexpress">AliExpress</option>
            <option value="amazon">Amazon</option>
            <option value="other">Autres</option>
          </select>
        </div>
        <div class="filter-group">
          <label for="priceRange">Gamme de prix :</label>
          <div class="price-range-container">
            <input type="range" id="priceMinRange" class="price-slider" min="0" max="1000" value="0" step="10">
            <input type="range" id="priceMaxRange" class="price-slider" min="0" max="1000" value="1000" step="10">
            <div class="price-display">
              <span id="priceMinDisplay">0‚Ç¨</span> - <span id="priceMaxDisplay">1000‚Ç¨+</span>
            </div>
          </div>
        </div>
        <div class="filter-group">
          <label for="sortBy">Trier par :</label>
          <select id="sortBy" class="filter-select">
            <option value="relevance">Pertinence</option>
            <option value="price_asc">Prix croissant</option>
            <option value="price_desc">Prix d√©croissant</option>
            <option value="rating_desc">Meilleures notes</option>
            <option value="newest">Plus r√©cents</option>
          </select>
        </div>
        <button id="clearFiltersBtn" class="clear-filters-btn">R√©initialiser les filtres</button>
      </div>
    </section>
    <!-- ===== MESSAGE DE BIENVENUE ===== -->
    <div id="welcomeMessage" class="welcome-message" style="display:none;">
      <h3>Bienvenue <span id="welcomeUserName"></span> ! üëã</h3>
      <p>Vous pouvez maintenant voter et laisser des avis sur les produits.</p>
    </div>
    <!-- ===== STATISTIQUES (remplac√©) ===== -->
    <div id="searchStats" class="search-stats" style="display: none;">
      <div class="search-results-info">
        <span id="resultsCount">0 r√©sultats</span>
        <span id="searchQuery"></span>
      </div>
    </div>
    <!-- ===== PRODUITS ===== -->
    <div id="productsContainer" class="products-container">
      <div class="loading-skeleton">
        <div class="skeleton-card"></div>
        <div class="skeleton-card"></div>
        <div class="skeleton-card"></div>
        <div class="skeleton-card"></div>
        <div class="skeleton-card"></div>
        <div class="skeleton-card"></div>
      </div>
    </div>
    <!-- ===== PAGINATION ===== -->
    <div id="pagination" class="pagination" style="display:none;">
      <button id="prevPageBtn" class="page-btn">‚Üê Pr√©c√©dent</button>
      <span id="pageInfo" class="page-info">Page 1</span>
      <button id="nextPageBtn" class="page-btn">Suivant ‚Üí</button>
    </div>
  </main>
  <!-- ==================== FOOTER ==================== -->
  <footer>
    <div class="container">
      <p>&copy; 2025 Sawem.shop - Tous droits r√©serv√©s. | +33 7 45 43 87 28 | <a href="mailto:imadbelkaceminfo@gmail.com">imadbelkaceminfo@gmail.com</a></p>
    </div>
  </footer>
  <!-- ==================== SCRIPTS ==================== -->
  <script>
const BACKEND_URL = "https://sawem-backend.onrender.com";
let currentUser = null;
let authToken = null;
// Auth functions
function getToken() {
  if (!authToken) authToken = localStorage.getItem('sawem_auth_token');
  return authToken;
}
function getAuthHeaders() {
  const token = getToken();
  return token ? {'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json'} : {'Content-Type': 'application/json'};
}
// Display products function
function displayProducts(products) {
  const container = document.getElementById('productsContainer');
  if (!products || products.length === 0) {
    container.innerHTML = '<div class="no-products">Aucun produit trouv√©</div>';
    return;
  }
  let html = '';
  products.forEach(product => {
    const isLoggedIn = !!currentUser;
    const sourceInfo = product.source ? `<div class="product-source">${product.source}</div>` : '';

    html += `
      <div class="product-card">
        <img src="${product.image}" alt="${product.title}" />
        ${sourceInfo}
        <div class="product-info">
          <h3>${product.title}</h3>
          <p class="price">${product.price}</p>
          <p class="rating">‚≠ê ${product.user_rating || 0}/5</p>
          <div class="product-actions">
            <a href="${product.link}" target="_blank" class="view-btn">Voir le produit</a>
            <button onclick="promptVote(${product.id})" class="vote-btn" ${!isLoggedIn ? 'disabled' : ''}>
              Noter
            </button>
          </div>
          ${isLoggedIn ? `
            <div class="review-section">
              <textarea id="review-${product.id}" placeholder="Votre avis..."></textarea>
              <button onclick="submitReview(${product.id})" class="send-review-btn">Envoyer</button>
            </div>
          ` : ''}
        </div>
      </div>
    `;
  });
  container.innerHTML = `<div class="product-grid">${html}</div>`;
}
// Load products
async function loadProducts() {
  try {
    const res = await fetch(`${BACKEND_URL}/products`, {
      headers: getAuthHeaders()
    });
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const products = await res.json();
    currentProducts = products; // Sauvegarder pour les filtres
    filteredProducts = products;
    displayProducts(products);
  } catch (err) {
    console.error('Load products error:', err);
    document.getElementById('productsContainer').innerHTML = '<p>Erreur de chargement des produits</p>';
  }
}
// Search functions
async function performTextSearch(query) {
  if (!query) {
    loadProducts();
    return;
  }
  try {
    const res = await fetch(`${BACKEND_URL}/search`, {
      method: 'POST',
      headers: getAuthHeaders(),
      body: JSON.stringify({ query: query.trim(), type: 'text' })
    });
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const products = await res.json();
    displayProducts(products);
    // Update stats
    document.getElementById('resultsCount').textContent = `${products.length} r√©sultats`;
    document.getElementById('searchQuery').textContent = `pour "${query}"`;
    document.getElementById('searchStats').style.display = 'block';
  } catch (err) {
    console.error('Text search error:', err);
    document.getElementById('productsContainer').innerHTML = '<p>Erreur de recherche</p>';
  }
}
async function performAISearch(query) {
  if (!query) return;
  try {
    const res = await fetch(`${BACKEND_URL}/search`, {
      method: 'POST',
      headers: getAuthHeaders(),
      body: JSON.stringify({ query: query.trim(), type: 'ai' })
    });
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const products = await res.json();
    displayProducts(products);
  } catch (err) {
    console.error('AI search error:', err);
    // Fallback to text search
    performTextSearch(query);
  }
}
// Variables pour les filtres
let currentProducts = [];
let filteredProducts = [];
// Fonction utilitaire pour extraire le prix num√©rique
function extractPrice(priceStr) {
  if (!priceStr) return 0;
  const numbers = priceStr.match(/[\d,\.]+/);
  return numbers ? parseFloat(numbers[0].replace(',', '.')) : 0;
}
// Initialisation des sliders de prix
function initPriceSliders() {
  const minSlider = document.getElementById('priceMinRange');
  const maxSlider = document.getElementById('priceMaxRange');
  const minDisplay = document.getElementById('priceMinDisplay');
  const maxDisplay = document.getElementById('priceMaxDisplay');
  function updatePriceDisplay() {
    const minVal = parseInt(minSlider.value);
    const maxVal = parseInt(maxSlider.value);
    // S'assurer que min <= max
    if (minVal > maxVal) {
      minSlider.value = maxVal;
      maxSlider.value = minVal;
    }
    minDisplay.textContent = minVal > 999 ? '1000‚Ç¨+' : minVal + '‚Ç¨';
    maxDisplay.textContent = maxVal >= 1000 ? '1000‚Ç¨+' : maxVal + '‚Ç¨';
    applyFilters();
  }
  minSlider.addEventListener('input', updatePriceDisplay);
  maxSlider.addEventListener('input', updatePriceDisplay);
}
// Fonction pour appliquer tous les filtres
function applyFilters() {
  if (!currentProducts.length) return;
  let filtered = [...currentProducts];
  // Filtre par source
  const sourceFilter = document.getElementById('sourceFilter').value;
  if (sourceFilter) {
    if (sourceFilter === 'aliexpress') {
      filtered = filtered.filter(p => (p.source || '').toLowerCase().includes('aliexpress'));
    } else if (sourceFilter === 'amazon') {
      filtered = filtered.filter(p => (p.source || '').toLowerCase().includes('amazon'));
    } else if (sourceFilter === 'other') {
      filtered = filtered.filter(p => {
        const source = (p.source || '').toLowerCase();
        return !source.includes('aliexpress') && !source.includes('amazon');
      });
    }
  }
  // Filtre par prix
  const minPrice = parseInt(document.getElementById('priceMinRange').value);
  const maxPrice = parseInt(document.getElementById('priceMaxRange').value);
  filtered = filtered.filter(p => {
    const price = extractPrice(p.price);
    return price >= minPrice && (maxPrice >= 1000 || price <= maxPrice);
  });
  // Tri
  const sortBy = document.getElementById('sortBy').value;
  switch(sortBy) {
    case 'price_asc':
      filtered.sort((a, b) => extractPrice(a.price) - extractPrice(b.price));
      break;
    case 'price_desc':
      filtered.sort((a, b) => extractPrice(b.price) - extractPrice(a.price));
      break;
    case 'rating_desc':
      filtered.sort((a, b) => (b.user_rating || 0) - (a.user_rating || 0));
      break;
    case 'newest':
      filtered.sort((a, b) => new Date(b.created_at || 0) - new Date(a.created_at || 0));
      break;
  }
  filteredProducts = filtered;
  displayProducts(filtered);
}
// Fonction pour r√©initialiser les filtres
function clearAllFilters() {
  document.getElementById('sourceFilter').value = '';
  document.getElementById('priceMinRange').value = 0;
  document.getElementById('priceMaxRange').value = 1000;
  document.getElementById('priceMinDisplay').textContent = '0‚Ç¨';
  document.getElementById('priceMaxDisplay').textContent = '1000‚Ç¨+';
  document.getElementById('sortBy').value = 'relevance';
  document.getElementById('searchInput').value = '';
  // Cacher les stats de recherche
  document.getElementById('searchStats').style.display = 'none';
  // Recharger tous les produits
  loadProducts();
}
// Fonction d'authentification am√©lior√©e
async function checkUser() {
  const authStatus = document.getElementById('authStatus');
  const googleLoginBtn = document.getElementById('googleLoginBtn');
  try {
    authStatus.textContent = "‚è≥ V√©rification...";
    authStatus.className = "auth-status loading";
    // V√©rifier le token dans l'URL
    const urlParams = new URLSearchParams(window.location.search);
    const urlToken = urlParams.get('token');
    if (urlToken) {
      localStorage.setItem('sawem_auth_token', urlToken);
      authToken = urlToken;
      window.history.replaceState({}, document.title, window.location.pathname);
    }
    const token = getToken();
    if (!token) {
      throw new Error("Aucun token");
    }
    const res = await fetch(`${BACKEND_URL}/verify-token`, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({token})
    });
    if (!res.ok) throw new Error('Token invalide');
    const data = await res.json();
    if (data.success && data.user) {
      currentUser = data.user;
      displayUserConnected(data.user);
    } else {
      throw new Error('Donn√©es utilisateur invalides');
    }
  } catch (err) {
    console.error('Auth error:', err);
    authToken = null;
    localStorage.removeItem('sawem_auth_token');
    displayUserDisconnected();
  }
}
function displayUserConnected(user) {
  const authStatus = document.getElementById('authStatus');
  const googleLoginBtn = document.getElementById('googleLoginBtn');
  const welcomeMessage = document.getElementById('welcomeMessage');
  const welcomeUserName = document.getElementById('welcomeUserName');
  const adminLink = document.getElementById('adminLink');
  authStatus.style.display = 'none';
  googleLoginBtn.style.display = 'none';
  if (welcomeUserName) welcomeUserName.textContent = user.name;
  if (welcomeMessage) welcomeMessage.style.display = 'block';
  if (adminLink && user.role === 'admin') {
    adminLink.style.display = 'flex';
  }
}
function displayUserDisconnected() {
  const authStatus = document.getElementById('authStatus');
  const googleLoginBtn = document.getElementById('googleLoginBtn');
  const welcomeMessage = document.getElementById('welcomeMessage');
  const adminLink = document.getElementById('adminLink');
  authStatus.textContent = "‚ùå Non connect√©";
  authStatus.className = "auth-status disconnected";
  authStatus.style.display = "block";
  googleLoginBtn.href = `${BACKEND_URL}/auth/google`;
  googleLoginBtn.style.display = "flex";
  if (welcomeMessage) welcomeMessage.style.display = 'none';
  if (adminLink) adminLink.style.display = 'none';
}
// Event listeners
document.addEventListener('DOMContentLoaded', () => {
  checkUser();
  loadProducts();
  // Initialiser les sliders de prix
  initPriceSliders();
  // Event listeners pour les filtres
  document.getElementById('sourceFilter').addEventListener('change', applyFilters);
  document.getElementById('sortBy').addEventListener('change', applyFilters);
  document.getElementById('clearFiltersBtn').addEventListener('click', clearAllFilters);
  // Search buttons
  document.getElementById('textSearchBtn').addEventListener('click', () => {
    const query = document.getElementById('searchInput').value.trim();
    performTextSearch(query);
  });
  document.getElementById('aiSearchBtn').addEventListener('click', () => {
    const query = document.getElementById('searchInput').value.trim();
    performAISearch(query);
  });
  // Category buttons
  document.querySelectorAll('.category-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const query = btn.dataset.search;
      document.getElementById('searchInput').value = query;
      performTextSearch(query);
    });
  });
});
</script>
</body>
</html>
