<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Administration - Sawem Shop</title>
  <meta name="description" content="Panel d'administration Sawem Shop">
  <link rel="stylesheet" href="admin-style.css">
</head>
<body>
  <header class="admin-header">
    <div class="header-content">
      <h1>üõí Administration Sawem.shop</h1>
      <div class="header-right">
        <span id="adminInfo" class="admin-info">‚è≥ V√©rification...</span>
        <button id="backToSiteBtn" class="back-btn" onclick="window.location.href='/'">Retour au site</button>
        <button id="logoutBtn" class="logout-btn">D√©connexion</button>
      </div>
    </div>
  </header>
  <div id="notification" class="notification" role="alert"></div>
  <div id="accessDenied" class="access-denied" style="display:none;">
    <h2>‚ùå Acc√®s refus√©</h2>
    <p>Vous devez √™tre administrateur pour acc√©der √† cette page.</p>
    <button onclick="window.location.href='/'">Retour au site</button>
  </div>
  <main id="adminMain" class="admin-main" style="display:none;">

    <!-- Navigation -->
    <nav class="admin-nav">
      <button class="nav-btn active" data-section="dashboard">üìä Dashboard</button>
      <button class="nav-btn" data-section="products">üì¶ Produits</button>
      <button class="nav-btn" data-section="users">üë• Utilisateurs</button>
      <button class="nav-btn" data-section="reviews">üí¨ Avis</button>
      <button class="nav-btn" data-section="settings">‚öôÔ∏è Param√®tres</button>
    </nav>
    <!-- Dashboard Section -->
    <section id="dashboard" class="admin-section active">
      <h2>üìä Tableau de bord</h2>
      <div class="stats-grid">
        <div class="stat-card">
          <h3>Produits actifs</h3>
          <div id="activeProducts" class="stat-number">-</div>
        </div>
        <div class="stat-card">
          <h3>Utilisateurs</h3>
          <div id="totalUsers" class="stat-number">-</div>
        </div>
        <div class="stat-card">
          <h3>Notes donn√©es</h3>
          <div id="totalRatings" class="stat-number">-</div>
        </div>
        <div class="stat-card">
          <h3>Avis publi√©s</h3>
          <div id="totalReviews" class="stat-number">-</div>
        </div>
      </div>
      <div class="recent-activity">
        <h3>Activit√© r√©cente</h3>
        <div id="recentActivity" class="activity-list">‚è≥ Chargement...</div>
      </div>
    </section>
    <!-- Products Section -->
    <section id="products" class="admin-section">
      <div class="section-header">
        <h2>üì¶ Gestion des produits</h2>
        <button id="addProductBtn" class="btn-primary">‚ûï Ajouter un produit</button>
      </div>
      <div class="filters">
        <input type="text" id="productSearch" placeholder="Rechercher un produit...">
        <select id="statusFilter">
          <option value="">Tous les statuts</option>
          <option value="active">Actif</option>
          <option value="inactive">Inactif</option>
        </select>
        <select id="sourceFilter">
          <option value="">Toutes les sources</option>
          <option value="aliexpress">AliExpress</option>
          <option value="amazon">Amazon</option>
          <option value="other">Autre</option>
        </select>
        <!-- Nouveau filtre cat√©gorie -->
        <select id="categoryFilter">
          <option value="">Toutes les cat√©gories</option>
          <option value="smartphones">Smartphones</option>
          <option value="laptops">Laptops</option>
          <option value="casques">Casques</option>
          <option value="montres">Montres</option>
          <option value="tablettes">Tablettes</option>
          <option value="appareils_photo">Appareils Photo</option>
          <option value="gaming">Gaming</option>
          <option value="drones">Drones</option>
          <option value="enceintes">Enceintes</option>
          <option value="claviers">Claviers</option>
          <option value="souris">Souris</option>
          <option value="ecrans">√âcrans</option>
          <option value="autres">Autres</option>
        </select>
      </div>
      <div class="products-table-container">
        <table id="productsTable" class="admin-table">
          <thead>
            <tr>
              <th>ID</th>
              <th>Image</th>
              <th>Titre</th>
              <th>Prix</th>
              <th>Source</th>
              <th>Cat√©gorie</th>
              <th>Note</th>
              <th>Statut</th>
              <th>Cr√©√© le</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <tr><td colspan="10">‚è≥ Chargement des produits...</td></tr>
          </tbody>
        </table>
      </div>
      <div class="pagination">
        <button id="prevPage" disabled>‚Üê Pr√©c√©dent</button>
        <span id="pageInfo">Page 1</span>
        <button id="nextPage">Suivant ‚Üí</button>
      </div>
    </section>
    <!-- Settings Section -->
    <section id="settings" class="admin-section">
      <h2>‚öôÔ∏è Param√®tres du site</h2>

      <div class="settings-grid">
        <div class="setting-card">
          <h3>üóÑÔ∏è Base de donn√©es</h3>
          <button id="backupBtn" class="btn-secondary">Cr√©er une sauvegarde</button>
          <div id="backupStatus"></div>
        </div>
        <div class="setting-card">
          <h3>üßπ Maintenance</h3>
          <button id="cacheBtn" class="btn-secondary">Vider le cache</button>
          <button id="reindexBtn" class="btn-secondary">R√©indexer les embeddings</button>
        </div>
        <div class="setting-card">
          <h3>üìä Statistiques</h3>
          <button id="exportStatsBtn" class="btn-secondary">Exporter les stats</button>
        </div>
        <!-- Nouveau bouton Migration -->
        <div class="setting-card">
          <h3>üîÑ Migration des donn√©es</h3>
          <button id="migrateBtn" class="btn-secondary">Migrer les produits existants</button>
          <div id="migrateStatus"></div>
        </div>
      </div>
    </section>
  </main>
  <!-- Modal pour ajouter/modifier un produit -->
  <div id="productModal" class="modal" style="display:none;">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="modalTitle">Ajouter un produit</h3>
        <button id="closeModal" class="close-btn">√ó</button>
      </div>

      <form id="productForm" class="product-form">
        <input type="hidden" id="productId">

        <div class="form-group">
          <label for="productTitle">Titre *</label>
          <input type="text" id="productTitle" required>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label for="productPrice">Prix *</label>
            <input type="text" id="productPrice" required placeholder="ex: 29.99‚Ç¨">
          </div>

          <div class="form-group">
            <label for="productSource">Source *</label>
            <select id="productSource" required>
              <option value="">Choisir une source</option>
              <option value="aliexpress">AliExpress</option>
              <option value="amazon">Amazon</option>
              <option value="other">Autre</option>
            </select>
          </div>
        </div>
        <div class="form-group">
          <label for="productLink">Lien d'affiliation *</label>
          <input type="url" id="productLink" required>
        </div>
        <div class="form-group">
          <label for="productImage">URL de l'image *</label>
          <input type="text" id="productImage" required>
          <div id="imagePreview" class="image-preview"></div>
        </div>
        <div class="form-group">
          <label for="productStatus">Statut</label>
          <select id="productStatus">
            <option value="active">Actif</option>
            <option value="inactive">Inactif</option>
          </select>
        </div>
        <!-- Nouveau champ Cat√©gorie -->
        <div class="form-group">
          <label for="productCategory">Cat√©gorie</label>
          <select id="productCategory">
            <option value="autres">Autres (auto-d√©tection)</option>
            <option value="smartphones">Smartphones</option>
            <option value="laptops">Laptops</option>
            <option value="casques">Casques</option>
            <option value="montres">Montres</option>
            <option value="tablettes">Tablettes</option>
            <option value="appareils_photo">Appareils Photo</option>
            <option value="gaming">Gaming</option>
            <option value="drones">Drones</option>
            <option value="enceintes">Enceintes</option>
            <option value="claviers">Claviers</option>
            <option value="souris">Souris</option>
            <option value="ecrans">√âcrans</option>
          </select>
        </div>
        <div class="modal-actions">
          <button type="button" id="cancelBtn" class="btn-secondary">Annuler</button>
          <button type="submit" class="btn-primary">
            <span id="submitText">Ajouter</span>
          </button>
        </div>
      </form>
    </div>
  </div>
<script>
  const BACKEND_URL = "https://sawem-backend.onrender.com";
  let currentUser = null;
  let products = [];
  let currentPage = 1;
  const perPage = 10;

  // Fonctions d'authentification
  function getToken() {
    return localStorage.getItem('sawem_auth_token');
  }

  function getAuthHeaders() {
    const token = getToken();
    return token ? {
      'Authorization': `Bearer ${token}`,
      'Content-Type': 'application/json'
    } : {
      'Content-Type': 'application/json'
    };
  }

  async function checkAuth() {
    try {
      const token = getToken();
      if (!token) throw new Error('No token');

      const res = await fetch(`${BACKEND_URL}/verify-token`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ token })
      });

      const data = await res.json();
      if (data.success && data.user && data.user.role === 'admin') {
        currentUser = data.user;
        document.getElementById('adminInfo').textContent = `Connect√©: ${data.user.name}`;
        document.getElementById('adminMain').style.display = 'block';
        loadDashboard();
      } else {
        throw new Error('Not admin');
      }
    } catch (error) {
      document.getElementById('accessDenied').style.display = 'block';
    }
  }

  // Charger les produits
  async function loadProducts() {
    const search = document.getElementById("productSearch").value;
    const status = document.getElementById("statusFilter").value;
    const source = document.getElementById("sourceFilter").value;
    const category = document.getElementById("categoryFilter").value;
    try {
      let url = `${BACKEND_URL}/admin/products?page=${currentPage}&limit=${perPage}`;
      if (search) url += `&search=${encodeURIComponent(search)}`;
      if (status) url += `&status=${status}`;
      if (source) url += `&source=${source}`;
      if (category) url += `&category=${category}`;

      const res = await fetch(url, {
        headers: getAuthHeaders()
      });

      if (!res.ok) throw new Error(`HTTP ${res.status}`);

      const data = await res.json();
      products = data.products || [];
      displayProducts(products);

      // Mettre √† jour la pagination
      document.getElementById('pageInfo').textContent = `Page ${data.page} sur ${data.totalPages}`;
      document.getElementById('prevPage').disabled = data.page <= 1;
      document.getElementById('nextPage').disabled = data.page >= data.totalPages;
    } catch (err) {
      console.error("Erreur chargement produits:", err);
      productsTable.innerHTML = "<tr><td colspan='10'>‚ö†Ô∏è Erreur lors du chargement</td></tr>";
    }
  }

  // Afficher les produits
  function displayProducts(list) {
    const productsTable = document.querySelector("#productsTable tbody");
    if (!list.length) {
      productsTable.innerHTML = "<tr><td colspan='10'>Aucun produit trouv√©</td></tr>";
      return;
    }
    productsTable.innerHTML = list.map(p => `
      <tr>
        <td>${p.id}</td>
        <td><img src="${p.image}" alt="img" width="50"></td>
        <td>${p.title}</td>
        <td>${p.price}</td>
        <td>${p.source}</td>
        <td>${p.category || "autres"}</td>
        <td>${p.rating || "-"}</td>
        <td>${p.status}</td>
        <td>${new Date(p.created_at).toLocaleDateString()}</td>
        <td>
          <button class="edit-btn" data-id="${p.id}">‚úèÔ∏è</button>
          <button class="delete-btn" data-id="${p.id}">üóëÔ∏è</button>
        </td>
      </tr>
    `).join("");

    // activer les boutons √©dition et suppression
    document.querySelectorAll(".edit-btn").forEach(btn => {
      btn.addEventListener("click", () => openEditModal(btn.dataset.id));
    });
    document.querySelectorAll(".delete-btn").forEach(btn => {
      btn.addEventListener("click", () => deleteProduct(btn.dataset.id));
    });
  }

  // Ouvrir modal en √©dition
  function openEditModal(id) {
    const p = products.find(x => x.id == id);
    if (!p) return;
    document.getElementById("productId").value = p.id;
    document.getElementById("productTitle").value = p.title;
    document.getElementById("productPrice").value = p.price;
    document.getElementById("productSource").value = p.source;
    document.getElementById("productLink").value = p.link || "";
    document.getElementById("productImage").value = p.image || "";
    document.getElementById("productStatus").value = p.status;
    document.getElementById("productCategory").value = p.category || "";
    document.getElementById("productModal").style.display = "block";
  }

  // Supprimer produit
  async function deleteProduct(id) {
    if (!confirm("Supprimer ce produit ?")) return;
    try {
      const res = await fetch(`${BACKEND_URL}/admin/products/${id}`, {
        method: "DELETE",
        headers: getAuthHeaders()
      });
      if (res.ok) {
        loadProducts();
      } else {
        alert("‚ùå Erreur suppression");
      }
    } catch (err) {
      console.error("Erreur suppression:", err);
    }
  }

  // Soumission produit
  document.getElementById("productForm").addEventListener("submit", async (e) => {
    e.preventDefault();
    const id = document.getElementById("productId").value;
    const payload = {
      title: document.getElementById("productTitle").value,
      price: document.getElementById("productPrice").value,
      source: document.getElementById("productSource").value,
      link: document.getElementById("productLink").value,
      image: document.getElementById("productImage").value,
      status: document.getElementById("productStatus").value,
      category: document.getElementById("productCategory").value
    };
    try {
      const url = id ? `${BACKEND_URL}/admin/products/${id}` : `${BACKEND_URL}/admin/products`;
      const method = id ? "PUT" : "POST";

      const res = await fetch(url, {
        method,
        headers: getAuthHeaders(),
        body: JSON.stringify(payload)
      });
      if (res.ok) {
        document.getElementById("productModal").style.display = "none";
        loadProducts();
      } else {
        alert("‚ùå Erreur lors de l'enregistrement");
      }
    } catch (err) {
      console.error("Erreur submit produit:", err);
    }
  });

  // Migration des donn√©es
  document.getElementById("migrateBtn").addEventListener("click", async () => {
    const migrateStatus = document.getElementById("migrateStatus");
    migrateStatus.innerText = "‚è≥ Migration en cours...";
    try {
      const res = await fetch(`${BACKEND_URL}/admin/migrate`, {
        method: "POST",
        headers: getAuthHeaders()
      });
      if (res.ok) {
        migrateStatus.innerText = "‚úÖ Migration termin√©e";
        loadProducts();
      } else {
        migrateStatus.innerText = "‚ùå Erreur migration";
      }
    } catch (err) {
      migrateStatus.innerText = "‚ö†Ô∏è Erreur serveur";
      console.error("Erreur migration:", err);
    }
  });

  // Gestion du modal
  document.getElementById("addProductBtn").addEventListener("click", () => {
    document.getElementById("productForm").reset();
    document.getElementById("productId").value = "";
    document.getElementById("productModal").style.display = "block";
  });
  document.getElementById("closeModal").addEventListener("click", () => {
    document.getElementById("productModal").style.display = "none";
  });
  document.getElementById("cancelBtn").addEventListener("click", () => {
    document.getElementById("productModal").style.display = "none";
  });

  // Filtres
  document.getElementById("productSearch").addEventListener("input", loadProducts);
  document.getElementById("statusFilter").addEventListener("change", loadProducts);
  document.getElementById("sourceFilter").addEventListener("change", loadProducts);
  document.getElementById("categoryFilter").addEventListener("change", loadProducts);

  // Charger le tableau de bord
  async function loadDashboard() {
    try {
      const res = await fetch(`${BACKEND_URL}/admin/stats`, {
        headers: getAuthHeaders()
      });
      const stats = await res.json();

      document.getElementById('activeProducts').textContent = stats.active_products;
      document.getElementById('totalUsers').textContent = stats.total_users;
      document.getElementById('totalRatings').textContent = stats.total_ratings;
      document.getElementById('totalReviews').textContent = stats.total_reviews;
    } catch (error) {
      console.error('Load dashboard error:', error);
    }
  }

  // Logout
  document.getElementById('logoutBtn').addEventListener('click', () => {
    localStorage.removeItem('sawem_auth_token');
    window.location.href = '/';
  });

  // Navigation entre sections
  document.querySelectorAll('.nav-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      // Retirer active de tous
      document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
      document.querySelectorAll('.admin-section').forEach(s => s.classList.remove('active'));

      // Activer le bouton et section cliqu√©s
      btn.classList.add('active');
      document.getElementById(btn.dataset.section).classList.add('active');

      // Charger les donn√©es si n√©cessaire
      if (btn.dataset.section === 'products') {
        loadProducts();
      }
    });
  });

  // Initialisation
  checkAuth();
</script>
</body>
</html>
