<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Administration - Sawem Shop</title>
  <meta name="description" content="Panel d'administration Sawem Shop">
  <link rel="stylesheet" href="admin-style.css">
</head>
<body>
  <header class="admin-header">
    <div class="header-content">
      <h1>🛒 Administration Sawem.shop</h1>
      <div class="header-right">
        <span id="adminInfo" class="admin-info">Connecté: Imad Belkacem</span>
        <button id="backToSiteBtn" class="back-btn" onclick="window.location.href='/'">Retour au site</button>
        <button id="logoutBtn" class="logout-btn">Déconnexion</button>
      </div>
    </div>
  </header>
  <div id="notification" class="notification" role="alert"></div>
  <div id="accessDenied" class="access-denied" style="display:none;">
    <h2>❌ Accès refusé</h2>
    <p>Vous devez être administrateur pour accéder à cette page.</p>
    <button onclick="window.location.href='/'">Retour au site</button>
  </div>
  <main id="adminMain" class="admin-main" style="display:none;">
    <!-- Navigation -->
    <nav class="admin-nav">
      <button class="nav-btn active" data-section="dashboard">📊 Dashboard</button>
      <button class="nav-btn" data-section="products">📦 Produits</button>
      <button class="nav-btn" data-section="users">👥 Utilisateurs</button>
      <button class="nav-btn" data-section="reviews">💬 Avis</button>
      <button class="nav-btn" data-section="settings">⚙️ Paramètres</button>
    </nav>
    <!-- Dashboard Section -->
    <section id="dashboard" class="admin-section active">
      <h2>📊 Tableau de bord</h2>
      <div class="stats-grid">
        <div class="stat-card">
          <h3>Produits actifs</h3>
          <div id="activeProducts" class="stat-number">-</div>
        </div>
        <div class="stat-card">
          <h3>Utilisateurs</h3>
          <div id="totalUsers" class="stat-number">-</div>
        </div>
        <div class="stat-card">
          <h3>Notes données</h3>
          <div id="totalRatings" class="stat-number">-</div>
        </div>
        <div class="stat-card">
          <h3>Avis publiés</h3>
          <div id="totalReviews" class="stat-number">-</div>
        </div>
      </div>
      <div class="recent-activity">
        <h3>Activité récente</h3>
        <div id="recentActivity" class="activity-list">⏳ Chargement...</div>
      </div>
    </section>
    <!-- Products Section -->
    <section id="products" class="admin-section">
      <div class="section-header">
        <h2>📦 Gestion des produits</h2>
        <button id="addProductBtn" class="btn-primary">➕ Ajouter un produit</button>
      </div>
      <div class="filters">
        <input type="text" id="productSearch" placeholder="Rechercher un produit...">
        <select id="statusFilter">
          <option value="">Tous les statuts</option>
          <option value="active">Actif</option>
          <option value="inactive">Inactif</option>
        </select>
        <select id="sourceFilter">
          <option value="">Toutes les sources</option>
          <option value="aliexpress">AliExpress</option>
          <option value="amazon">Amazon</option>
          <option value="other">Autre</option>
        </select>
        <!-- Nouveau filtre catégorie -->
        <select id="categoryFilter">
          <option value="">Toutes les catégories</option>
          <option value="smartphones">Smartphones</option>
          <option value="laptops">Laptops</option>
          <option value="casques">Casques</option>
          <option value="montres">Montres</option>
          <option value="tablettes">Tablettes</option>
          <option value="appareils_photo">Appareils Photo</option>
          <option value="gaming">Gaming</option>
          <option value="drones">Drones</option>
          <option value="enceintes">Enceintes</option>
          <option value="claviers">Claviers</option>
          <option value="souris">Souris</option>
          <option value="ecrans">Écrans</option>
          <option value="autres">Autres</option>
        </select>
      </div>
      <div class="products-table-container">
        <table id="productsTable" class="admin-table">
          <thead>
            <tr>
              <th>ID</th>
              <th>Image</th>
              <th>Titre</th>
              <th>Prix</th>
              <th>Source</th>
              <th>Catégorie</th>
              <th>Note</th>
              <th>Statut</th>
              <th>Créé le</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <tr><td colspan="10">⏳ Chargement des produits...</td></tr>
          </tbody>
        </table>
      </div>
      <div class="pagination">
        <button id="prevPage" disabled>← Précédent</button>
        <span id="pageInfo">Page 1</span>
        <button id="nextPage">Suivant →</button>
      </div>
    </section>
    <!-- Users Section -->
    <section id="users" class="admin-section">
      <h2>👥 Gestion des utilisateurs</h2>
      <div id="usersContent">⏳ Chargement...</div>
    </section>
    <!-- Reviews Section -->
    <section id="reviews" class="admin-section">
      <h2>💬 Gestion des avis</h2>
      <div id="reviewsContent">⏳ Chargement...</div>
    </section>
    <!-- Settings Section -->
    <section id="settings" class="admin-section">
      <h2>⚙️ Paramètres du site</h2>
      <div class="settings-grid">
        <div class="setting-card">
          <h3>🗄️ Base de données</h3>
          <button id="backupBtn" class="btn-secondary">Créer une sauvegarde</button>
          <div id="backupStatus"></div>
        </div>
        <div class="setting-card">
          <h3>🧹 Maintenance</h3>
          <button id="cacheBtn" class="btn-secondary">Vider le cache</button>
          <button id="reindexBtn" class="btn-secondary">Réindexer les embeddings</button>
        </div>
        <div class="setting-card">
          <h3>📊 Statistiques</h3>
          <button id="exportStatsBtn" class="btn-secondary">Exporter les stats</button>
        </div>
        <!-- Nouveau bouton Migration -->
        <div class="setting-card">
          <h3>🔄 Migration des données</h3>
          <button id="migrateBtn" class="btn-secondary">Migrer les produits existants</button>
          <div id="migrateStatus"></div>
        </div>
      </div>
    </section>
  </main>
  <!-- Modal pour ajouter/modifier un produit -->
  <div id="productModal" class="modal" style="display:none;">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="modalTitle">Ajouter un produit</h3>
        <button id="closeModal" class="close-btn">×</button>
      </div>
      <form id="productForm" class="product-form">
        <input type="hidden" id="productId">
        <div class="form-group">
          <label for="productTitle">Titre *</label>
          <input type="text" id="productTitle" required>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label for="productPrice">Prix *</label>
            <input type="text" id="productPrice" required placeholder="ex: 29.99€">
          </div>
          <div class="form-group">
            <label for="productSource">Source *</label>
            <select id="productSource" required>
              <option value="">Choisir une source</option>
              <option value="aliexpress">AliExpress</option>
              <option value="amazon">Amazon</option>
              <option value="other">Autre</option>
            </select>
          </div>
        </div>
        <div class="form-group">
          <label for="productLink">Lien d'affiliation *</label>
          <input type="url" id="productLink" required>
        </div>
        <div class="form-group">
          <label for="productImage">URL de l'image *</label>
          <input type="text" id="productImage" required>
          <div id="imagePreview" class="image-preview"></div>
        </div>
        <div class="form-group">
          <label for="productStatus">Statut</label>
          <select id="productStatus">
            <option value="active">Actif</option>
            <option value="inactive">Inactif</option>
          </select>
        </div>
        <!-- Nouveau champ Catégorie -->
        <div class="form-group">
          <label for="productCategory">Catégorie</label>
          <select id="productCategory">
            <option value="autres">Autres (auto-détection)</option>
            <option value="smartphones">Smartphones</option>
            <option value="laptops">Laptops</option>
            <option value="casques">Casques</option>
            <option value="montres">Montres</option>
            <option value="tablettes">Tablettes</option>
            <option value="appareils_photo">Appareils Photo</option>
            <option value="gaming">Gaming</option>
            <option value="drones">Drones</option>
            <option value="enceintes">Enceintes</option>
            <option value="claviers">Claviers</option>
            <option value="souris">Souris</option>
            <option value="ecrans">Écrans</option>
          </select>
        </div>
        <div class="modal-actions">
          <button type="button" id="cancelBtn" class="btn-secondary">Annuler</button>
          <button type="submit" class="btn-primary">
            <span id="submitText">Ajouter</span>
          </button>
        </div>
      </form>
    </div>
  </div>
<script>
  const BACKEND_URL = "https://sawem-backend.onrender.com";
  let currentUser = null;
  let products = [];
  let currentPage = 1;
  const perPage = 10;
  // Fonctions d'authentification
  function getToken() {
    return localStorage.getItem('sawem_auth_token');
  }
  function getAuthHeaders() {
    const token = getToken();
    return token ? {
      'Authorization': `Bearer ${token}`,
      'Content-Type': 'application/json'
    } : {
      'Content-Type': 'application/json'
    };
  }
  async function checkAuth() {
    try {
      const token = getToken();
      if (!token) throw new Error('No token');
      const res = await fetch(`${BACKEND_URL}/verify-token`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ token })
      });
      const data = await res.json();
      if (data.success && data.user && data.user.role === 'admin') {
        currentUser = data.user;
        document.getElementById('adminInfo').textContent = `Connecté: ${data.user.name}`;
        document.getElementById('adminMain').style.display = 'block';
        loadDashboard();
      } else {
        throw new Error('Not admin');
      }
    } catch (error) {
      document.getElementById('accessDenied').style.display = 'block';
    }
  }
  // CORRECTION 1: Activité récente
  async function loadRecentActivity() {
    try {
      const res = await fetch(`${BACKEND_URL}/admin/recent-activity`, {
        headers: getAuthHeaders()
      });

      if (!res.ok) throw new Error('Failed to load activity');

      const activities = await res.json();
      const container = document.getElementById('recentActivity');

      if (activities.length === 0) {
        container.innerHTML = '<p>Aucune activité récente</p>';
        return;
      }

      container.innerHTML = activities.map(activity => `
        <div class="activity-item">
          <div class="activity-icon">${getActivityIcon(activity.type)}</div>
          <div class="activity-text">${activity.description}</div>
          <div class="activity-time">${new Date(activity.created_at).toLocaleDateString()}</div>
        </div>
      `).join('');
    } catch (error) {
      console.error('Load activity error:', error);
      document.getElementById('recentActivity').innerHTML = '⚠️ Erreur lors du chargement';
    }
  }
  function getActivityIcon(type) {
    switch(type) {
      case 'user_registered': return '👤';
      case 'review_posted': return '💬';
      case 'vote_cast': return '⭐';
      default: return '📝';
    }
  }
  // CORRECTION 2: Charger les produits avec pagination corrigée
  async function loadProducts() {
    const search = document.getElementById("productSearch")?.value || "";
    const status = document.getElementById("statusFilter")?.value || "";
    const source = document.getElementById("sourceFilter")?.value || "";
    const category = document.getElementById("categoryFilter")?.value || "";

    try {
      let url = `${BACKEND_URL}/admin/products?page=${currentPage}&limit=${perPage}`;
      if (search) url += `&search=${encodeURIComponent(search)}`;
      if (status) url += `&status=${status}`;
      if (source) url += `&source=${source}`;
      if (category) url += `&category=${category}`;
      console.log('Loading products from:', url); // Debug
      const res = await fetch(url, {
        headers: getAuthHeaders()
      });
      console.log('Response status:', res.status); // Debug
      if (!res.ok) {
        const errorText = await res.text();
        throw new Error(`HTTP ${res.status}: ${errorText}`);
      }
      const data = await res.json();
      console.log('Products data:', data); // Debug

      products = data.products || [];
      displayProducts(products);
      updateProductsPagination(data);
    } catch (err) {
      console.error("Erreur chargement produits:", err);
      const tbody = document.querySelector("#productsTable tbody");
      if (tbody) {
        tbody.innerHTML = `<tr><td colspan='10'>⚠️ Erreur: ${err.message}</td></tr>`;
      }
    }
  }
  // CORRECTION 3: Pagination des produits
  function updateProductsPagination(data) {
    document.getElementById('pageInfo').textContent = `Page ${data.page || 1} sur ${data.totalPages || 1}`;
    document.getElementById('prevPage').disabled = (data.page || 1) <= 1;
    document.getElementById('nextPage').disabled = (data.page || 1) >= (data.totalPages || 1);
  }
  // CORRECTION 4: Afficher les produits avec style amélioré
  function displayProducts(list) {
    const productsTable = document.querySelector("#productsTable tbody");
    if (!list.length) {
      productsTable.innerHTML = "<tr><td colspan='10' class='text-center'>Aucun produit trouvé</td></tr>";
      return;
    }

    productsTable.innerHTML = list.map(p => `
      <tr>
        <td><strong>#${p.id}</strong></td>
        <td>
          <img src="${p.image}" alt="img" class="product-thumb"
               onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNTAiIGhlaWdodD0iNTAiIHZpZXdCb3g9IjAgMCA1MCA1MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjUwIiBoZWlnaHQ9IjUwIiBmaWxsPSIjRjNGNEY2Ii8+CjxwYXRoIGQ9Ik0yNSAzNUMzMC41MjI4IDM1IDM1IDMwLjUyMjggMzUgMjVDMTkuNDc3MiAxNSAxNSAxOS40NzcyIDE1IDI1QzE1IDMwLjUyMjggMTkuNDc3MiAzNSAyNSAzNSIgZmlsbD0iIzZDNzU3RCIvPgo8L3N2Zz4='" />
        </td>
        <td>
          <div class="product-title" title="${p.title}">${p.title}</div>
        </td>
        <td><strong style="color: #0d6efd;">${p.price}</strong></td>
        <td>
          <span class="source-badge source-${p.source && p.source.toLowerCase().includes('aliexpress') ? 'aliexpress' :  p.source && p.source.toLowerCase().includes('amazon') ? 'amazon' : 'other'}">
            ${p.source && p.source.toLowerCase().includes('aliexpress') ? 'AliExpress' : p.source && p.source.toLowerCase().includes('amazon') ? 'Amazon' : 'Autre'}
          </span>
        </td>
        <td>
          <span style="background: #e9ecef; padding: 0.2rem 0.6rem; border-radius: 12px; font-size: 0.8rem;">
            ${p.category || "autres"}
          </span>
        </td>
        <td>
          <div style="display: flex; align-items: center; gap: 0.5rem;">
            ${renderAdminStars(p.user_rating || 0)}
            <span style="font-size: 0.8rem; color: #6c757d;">${Number(p.user_rating || 0).toFixed(1)}</span>
          </div>
        </td>
        <td>
          <span class="status-badge status-${p.status || 'active'}">${p.status || 'active'}</span>
        </td>
        <td style="font-size: 0.8rem; color: #6c757d;">
          ${new Date(p.created_at).toLocaleDateString()}
        </td>
        <td>
          <div class="actions">
            <button class="btn-edit" data-id="${p.id}">✏️ Modifier</button>
            <button class="btn-delete" data-id="${p.id}">🗑️ Supprimer</button>
          </div>
        </td>
      </tr>
    `).join("");
    // Activer les boutons édition et suppression
    document.querySelectorAll(".btn-edit").forEach(btn => {
      btn.addEventListener("click", () => openEditModal(btn.dataset.id));
    });
    document.querySelectorAll(".btn-delete").forEach(btn => {
      btn.addEventListener("click", () => deleteProduct(btn.dataset.id));
    });
  }
  // Fonction pour afficher les étoiles dans l'admin
  function renderAdminStars(rating) {
    const numRating = Number(rating) || 0;
    const fullStars = Math.floor(numRating);
    let starsHTML = '';
    for (let i = 1; i <= 5; i++) {
      starsHTML += `<span style="color: ${i <= fullStars ? '#ffc107' : '#dee2e6'};">★</span>`;
    }
    return starsHTML;
  }
  // CORRECTION 5: Charger les utilisateurs
  async function loadUsers() {
    try {
      const res = await fetch(`${BACKEND_URL}/admin/users`, {
        headers: getAuthHeaders()
      });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const users = await res.json();
      displayUsers(users);
    } catch (error) {
      console.error('Load users error:', error);
      // Créer la table utilisateurs si elle n'existe pas
      const usersSection = document.getElementById('users');
      if (usersSection && !usersSection.innerHTML.trim()) {
        usersSection.innerHTML = `
          <h2>👥 Gestion des utilisateurs</h2>
          <div class="users-table-container">
            <table class="admin-table">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Avatar</th>
                  <th>Nom</th>
                  <th>Email</th>
                  <th>Rôle</th>
                  <th>Inscription</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                <tr><td colspan="7">⚠️ Erreur lors du chargement</td></tr>
              </tbody>
            </table>
          </div>
        `;
      }
    }
  }
  function displayUsers(users) {
    // Créer la section utilisateurs si elle n'existe pas
    let usersSection = document.getElementById('users');
    if (!usersSection.innerHTML.includes('users-table-container')) {
      usersSection.innerHTML = `
        <h2>👥 Gestion des utilisateurs</h2>
        <div class="filters">
          <input type="text" id="userSearch" placeholder="Rechercher un utilisateur...">
          <select id="roleFilter">
            <option value="">Tous les rôles</option>
            <option value="admin">Administrateur</option>
            <option value="user">Utilisateur</option>
          </select>
        </div>
        <div class="users-table-container">
          <table class="admin-table">
            <thead>
              <tr>
                <th>ID</th>
                <th>Avatar</th>
                <th>Nom</th>
                <th>Email</th>
                <th>Rôle</th>
                <th>Inscription</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      `;
    }
    const tbody = usersSection.querySelector('tbody');
    if (!users.length) {
      tbody.innerHTML = "<tr><td colspan='7' class='text-center'>Aucun utilisateur trouvé</td></tr>";
      return;
    }
    tbody.innerHTML = users.map(user => `
      <tr>
        <td><strong>#${user.id}</strong></td>
        <td>
          <img src="${user.photo || `https://ui-avatars.com/api/?name=${encodeURIComponent(user.name || 'User')}&size=40`}" alt="Avatar" class="user-thumb" />
        </td>
        <td><strong>${user.name || 'N/A'}</strong></td>
        <td>${user.email}</td>
        <td>
          <span class="role-badge role-${user.role || 'user'}">${user.role || 'user'}</span>
        </td>
        <td style="font-size: 0.8rem; color: #6c757d;">
          ${new Date(user.created_at).toLocaleDateString()}
        </td>
        <td>
          <select onchange="changeUserRole(${user.id}, this.value)" ${user.role === 'admin' && user.id === currentUser.id ? 'disabled' : ''}>
            <option value="user" ${user.role === 'user' ? 'selected' : ''}>Utilisateur</option>
            <option value="admin" ${user.role === 'admin' ? 'selected' : ''}>Admin</option>
          </select>
        </td>
      </tr>
    `).join('');
  }
  // CORRECTION 6: Charger les avis
  async function loadReviews() {
    try {
      const res = await fetch(`${BACKEND_URL}/admin/reviews`, {
        headers: getAuthHeaders()
      });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const reviews = await res.json();
      displayReviews(reviews);
    } catch (error) {
      console.error('Load reviews error:', error);
    }
  }
  function displayReviews(reviews) {
    // Créer la section avis si elle n'existe pas
    let reviewsSection = document.getElementById('reviews');
    if (!reviewsSection.innerHTML.includes('reviews-list')) {
      reviewsSection.innerHTML = `
        <h2>💬 Gestion des avis</h2>
        <div class="filters">
          <input type="text" id="reviewSearch" placeholder="Rechercher dans les avis...">
          <input type="number" id="productIdFilter" placeholder="ID du produit">
        </div>
        <div class="reviews-list"></div>
      `;
    }
    const container = reviewsSection.querySelector('.reviews-list');
    if (!reviews.length) {
      container.innerHTML = '<p class="text-center">Aucun avis trouvé</p>';
      return;
    }
    container.innerHTML = reviews.map(review => `
      <div class="review-card">
        <div class="review-header">
          <strong>${review.user_name}</strong>
          <span class="review-product">Produit: ${review.product_title || `#${review.product_id}`}</span>
          <span class="review-date">${new Date(review.created_at).toLocaleDateString()}</span>
        </div>
        <div class="review-content">${review.comment}</div>
        <div class="review-actions">
          <button class="btn-delete" onclick="deleteReview(${review.id})">🗑️ Supprimer</button>
        </div>
      </div>
    `).join('');
  }
  // CORRECTION 7: Event listeners pour la pagination
  document.getElementById('prevPage').addEventListener('click', () => {
    if (currentPage > 1) {
      currentPage--;
      loadProducts();
    }
  });
  document.getElementById('nextPage').addEventListener('click', () => {
    currentPage++;
    loadProducts();
  });
  // CORRECTION 8: Validation d'image avec support des chemins relatifs
  document.getElementById('productImage').addEventListener('input', function() {
    const imageUrl = this.value;
    const preview = document.getElementById('imagePreview');

    if (imageUrl) {
      let fullImageUrl = imageUrl;
      if (imageUrl.startsWith('Images/')) {
        fullImageUrl = `${BACKEND_URL}/${imageUrl}`;
      }
      preview.innerHTML = `<img src="${fullImageUrl}" alt="Preview" onerror="this.parentNode.innerHTML='<p>Image non disponible</p>'">`;
    } else {
      preview.innerHTML = '<p>Aucune image sélectionnée</p>';
    }
  });
  // Fonction pour gérer la soumission du formulaire produit
  document.getElementById('productForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    const productId = document.getElementById('productId').value;
    const productTitle = document.getElementById('productTitle').value;
    const productPrice = document.getElementById('productPrice').value;
    const productSource = document.getElementById('productSource').value;
    const productLink = document.getElementById('productLink').value;
    const productImage = document.getElementById('productImage').value;
    const productStatus = document.getElementById('productStatus').value;
    const productCategory = document.getElementById('productCategory').value;

    const productData = {
      title: productTitle,
      price: productPrice,
      source: productSource,
      link: productLink,
      image: productImage,
      status: productStatus,
      category: productCategory
    };

    try {
      let url = `${BACKEND_URL}/admin/products`;
      let method = 'POST';
      if (productId) {
        url += `/${productId}`;
        method = 'PUT';
      }

      const response = await fetch(url, {
        method: method,
        headers: getAuthHeaders(),
        body: JSON.stringify(productData)
      });

      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }

      const data = await response.json();
      if (data.success) {
        showNotification('Produit enregistré avec succès!');
        closeProductModal();
        loadProducts();
      } else {
        showNotification('Erreur lors de l\'enregistrement du produit.', true);
      }
    } catch (error) {
      console.error('Error saving product:', error);
      showNotification('Erreur lors de l\'enregistrement du produit.', true);
    }
  });
  // Afficher une notification
  function showNotification(message, isError = false) {
    const notification = document.getElementById('notification');
    notification.textContent = message;
    notification.className = `notification ${isError ? 'error' : ''}`;
    notification.style.display = 'block';
    setTimeout(() => {
      notification.style.display = 'none';
    }, 5000);
  }
  // Fonction pour ouvrir le modal produit
  function openProductModal(product = null) {
    const modal = document.getElementById('productModal');
    const form = document.getElementById('productForm');
    const modalTitle = document.getElementById('modalTitle');
    const submitText = document.getElementById('submitText');

    // Réinitialiser le formulaire
    form.reset();
    document.getElementById('productId').value = '';
    document.getElementById('imagePreview').innerHTML = '<p>Aucune image sélectionnée</p>';

    if (product) {
      // Mode édition
      modalTitle.textContent = 'Modifier un produit';
      submitText.textContent = 'Enregistrer';
      document.getElementById('productId').value = product.id;
      document.getElementById('productTitle').value = product.title;
      document.getElementById('productPrice').value = product.price;
      document.getElementById('productSource').value = product.source;
      document.getElementById('productLink').value = product.link;
      document.getElementById('productImage').value = product.image;
      document.getElementById('productStatus').value = product.status;
      document.getElementById('productCategory').value = product.category || 'autres';

      // Afficher l'image de prévisualisation si elle existe
      if (product.image) {
        const preview = document.getElementById('imagePreview');
        let fullImageUrl = product.image;
        if (product.image.startsWith('Images/')) {
          fullImageUrl = `${BACKEND_URL}/${product.image}`;
        }
        preview.innerHTML = `<img src="${fullImageUrl}" alt="Preview" onerror="this.parentNode.innerHTML='<p>Image non disponible</p>'">`;
      }
    } else {
      // Mode ajout
      modalTitle.textContent = 'Ajouter un produit';
      submitText.textContent = 'Ajouter';
    }

    // Afficher le modal
    modal.style.display = 'flex';
  }
  // Fonction pour fermer le modal produit
  function closeProductModal() {
    document.getElementById('productModal').style.display = 'none';
  }
  // Gestionnaire pour le bouton "Ajouter un produit"
  document.getElementById('addProductBtn').addEventListener('click', () => {
    openProductModal();
  });
  // Gestionnaire pour le bouton de fermeture du modal
  document.getElementById('closeModal').addEventListener('click', closeProductModal);
  // Gestionnaire pour le bouton d'annulation du modal
  document.getElementById('cancelBtn').addEventListener('click', closeProductModal);
  // Fonction pour ouvrir le modal en mode édition
  function openEditModal(productId) {
    // Rechercher le produit dans la liste des produits
    const product = products.find(p => p.id == productId);
    if (product) {
      openProductModal(product);
    } else {
      showNotification('Produit non trouvé.', true);
    }
  }
  // Fonction pour supprimer un produit
  async function deleteProduct(productId) {
    if (confirm('Êtes-vous sûr de vouloir supprimer ce produit?')) {
      try {
        const response = await fetch(`${BACKEND_URL}/admin/products/${productId}`, {
          method: 'DELETE',
          headers: getAuthHeaders()
        });

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        const data = await response.json();
        if (data.success) {
          showNotification('Produit supprimé avec succès!');
          loadProducts();
        } else {
          showNotification('Erreur lors de la suppression du produit.', true);
        }
      } catch (error) {
        console.error('Error deleting product:', error);
        showNotification('Erreur lors de la suppression du produit.', true);
      }
    }
  }
  // Fonction pour changer le rôle d'un utilisateur
  async function changeUserRole(userId, newRole) {
    try {
      const response = await fetch(`${BACKEND_URL}/admin/users/${userId}/role`, {
        method: 'PUT',
        headers: getAuthHeaders(),
        body: JSON.stringify({ role: newRole })
      });

      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }

      const data = await response.json();
      if (data.success) {
        showNotification('Rôle utilisateur mis à jour avec succès!');
      } else {
        showNotification('Erreur lors de la mise à jour du rôle.', true);
      }
    } catch (error) {
      console.error('Error updating user role:', error);
      showNotification('Erreur lors de la mise à jour du rôle.', true);
    }
  }
  // Fonction pour supprimer un avis
  async function deleteReview(reviewId) {
    if (confirm('Êtes-vous sûr de vouloir supprimer cet avis?')) {
      try {
        const response = await fetch(`${BACKEND_URL}/admin/reviews/${reviewId}`, {
          method: 'DELETE',
          headers: getAuthHeaders()
        });

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        const data = await response.json();
        if (data.success) {
          showNotification('Avis supprimé avec succès!');
          loadReviews();
        } else {
          showNotification('Erreur lors de la suppression de l\'avis.', true);
        }
      } catch (error) {
        console.error('Error deleting review:', error);
        showNotification('Erreur lors de la suppression de l\'avis.', true);
      }
    }
  }
  // Charger le contenu de la section active
  function loadSectionContent() {
    const activeSection = document.querySelector('.admin-section.active');
    if (activeSection) {
      const sectionId = activeSection.id;
      switch (sectionId) {
        case 'dashboard':
          loadDashboard();
          break;
        case 'products':
          loadProducts();
          break;
        case 'users':
          loadUsers();
          break;
        case 'reviews':
          loadReviews();
          break;
      }
    }
  }
  // Charger les données du tableau de bord
  async function loadDashboard() {
    try {
      // Charger les statistiques
      const statsResponse = await fetch(`${BACKEND_URL}/admin/stats`, {
        headers: getAuthHeaders()
      });

      if (!statsResponse.ok) throw new Error('Failed to load stats');

      const stats = await statsResponse.json();

      document.getElementById('activeProducts').textContent = stats.activeProducts || 0;
      document.getElementById('totalUsers').textContent = stats.totalUsers || 0;
      document.getElementById('totalRatings').textContent = stats.totalRatings || 0;
      document.getElementById('totalReviews').textContent = stats.totalReviews || 0;

      // Charger l'activité récente
      loadRecentActivity();
    } catch (error) {
      console.error('Load dashboard error:', error);
    }
  }
  // Gestionnaire pour la navigation
  document.querySelectorAll('.nav-btn').forEach(button => {
    button.addEventListener('click', function() {
      const sectionId = this.getAttribute('data-section');
      // Masquer toutes les sections
      document.querySelectorAll('.admin-section').forEach(section => {
        section.classList.remove('active');
      });
      // Désactiver tous les boutons
      document.querySelectorAll('.nav-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      // Activer la section et le bouton cliqués
      document.getElementById(sectionId).classList.add('active');
      this.classList.add('active');
      // Charger le contenu de la nouvelle section active
      loadSectionContent();
    });
  });
  // Gestionnaire pour les filtres de produits
  document.querySelectorAll('#productSearch, #statusFilter, #sourceFilter, #categoryFilter').forEach(element => {
    element.addEventListener('change', loadProducts);
    element.addEventListener('keyup', function() {
      if (this.id === 'productSearch') {
        loadProducts();
      }
    });
  });
  // Gestionnaire pour le bouton de déconnexion
  document.getElementById('logoutBtn').addEventListener('click', function() {
    localStorage.removeItem('sawem_auth_token');
    window.location.href = '/login.html';
  });
  // Au chargement de la page
  window.onload = function() {
    checkAuth();
    // Ajouter des gestionnaires d'événements supplémentaires si nécessaire
    // Par exemple pour les boutons de sauvegarde, migration, etc.
    document.getElementById('backupBtn').addEventListener('click', () => alert('Fonctionnalité de sauvegarde à implémenter'));
    document.getElementById('cacheBtn').addEventListener('click', () => alert('Fonctionnalité de vidage du cache à implémenter'));
    document.getElementById('reindexBtn').addEventListener('click', () => alert('Fonctionnalité de réindexation à implémenter'));
    document.getElementById('exportStatsBtn').addEventListener('click', () => alert('Fonctionnalité d\'exportation des stats à implémenter'));
    document.getElementById('migrateBtn').addEventListener('click', () => alert('Fonctionnalité de migration à implémenter'));
  };
</script>
</body>
</html>
